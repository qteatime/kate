<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><link rel="next" title="#F0002 — KART cartridges" href="F0002-kart.html" /><link rel="prev" title="Kate’s Design Documents" href="../index.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2023.09.10 -->
        <title>#F0001 — The LJT language - Kate 0.25 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=82a976d7" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=d1035e3f" />
    
    


<style>
  body {
    --color-code-background: #ffffff;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<div class="announcement">
  <aside class="announcement-content">
     Both Kate and this documentation are a work in progress and may change at any time. 
  </aside>
</div>

<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">Kate 0.25 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">Kate 0.25 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">End-user books</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../user/manual/index.html">The Kate User Manual</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of The Kate User Manual</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../user/manual/intro/index.html">Getting started</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Getting started</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/intro/hardware.html">Tech specs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/intro/emulator.html">Emulator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/intro/install.html">Installing</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../user/manual/gaming/index.html">Playing games</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Playing games</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/gaming/cartridges.html">ROM Cartridges</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/gaming/captures.html">Screen recording</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/gaming/save-data.html">Save data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/gaming/play-habits.html">Play habits</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/gaming/storage.html">Stored data</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../user/manual/security/index.html">Security and privacy</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of Security and privacy</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/security/philosophy.html">Safety philosophy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/security/sandboxing.html">Sandboxing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/security/privacy.html">Privacy policy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/security/trust.html">Trust and consent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/security/audit.html">Audit logs</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../user/importer/index.html">The Kate Importer Manual</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of The Kate Importer Manual</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../user/importer/renpy.html">Ren’Py</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user/importer/bitsy.html">Bitsy</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../user/diy/index.html">Build Your Own Console!</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Build Your Own Console!</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../user/diy/overview/index.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user/diy/hardware/index.html">The hardware</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Game developer books</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../dev/manual/index.html">Making games for Kate!</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of Making games for Kate!</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../dev/manual/intro/index.html">Getting started</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of Getting started</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/intro/why.html">Why make games for Kate?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/intro/setup.html">What will you need?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/intro/hello-world.html">Hello, World</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../dev/manual/model/index.html">Programming model</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of Programming model</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/model/overview.html">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/model/cartridges.html">Cartridges</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/model/sandboxing.html">Sandboxing and APIs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/model/capabilities.html">Capabilities</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../dev/manual/api/index.html">Kate API</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of Kate API</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/api/events.html"><code class="docutils literal notranslate"><span class="pre">events</span></code> — Event handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/api/cart-fs.html"><code class="docutils literal notranslate"><span class="pre">cart_fs</span></code> — Reading files</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/api/input.html"><code class="docutils literal notranslate"><span class="pre">*_input</span></code> — Reacting to player input</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/api/timer.html"><code class="docutils literal notranslate"><span class="pre">timer</span></code> — Scheduling updates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/api/capture.html"><code class="docutils literal notranslate"><span class="pre">capture</span></code> — Screenshots and video recording</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/api/store.html"><code class="docutils literal notranslate"><span class="pre">store</span></code> — Saving state</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/api/browser.html"><code class="docutils literal notranslate"><span class="pre">browser</span></code> — Navigating to URLs</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../dev/manual/web/index.html">Web game support</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle navigation of Web game support</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/web/basics.html">Basics of porting</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../dev/manual/web/bridges/index.html">Bridges</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle navigation of Bridges</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/network-proxy.html">Network proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/input-proxy.html">Button input proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/pointer-input-proxy.html">Pointer input proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/local-storage-proxy.html">Local storage proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/indexeddb-proxy.html">IndexedDB proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/external-url-handler.html">External URL handler</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/preserve-webgl-render.html">Preserve WebGL Render</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/capture-canvas.html">Capture canvas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/renpy-tweaks.html">Ren’Py tweaks</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../dev/manual/packing/index.html">Packaging cartridges</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle navigation of Packaging cartridges</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/packing/getting-started.html">Getting started</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/packing/configuration.html">Configuration files</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../dev/port/index.html">Kate Porting Recipes</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><div class="visually-hidden">Toggle navigation of Kate Porting Recipes</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../dev/port/bitsy.html">Bitsy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/port/renpy.html">Ren’Py</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/port/godot.html">Godot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/port/rpg-maker.html">RPG Maker MV</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/port/gamemaker.html">GameMaker</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Design and implementation</span></p>
<ul class="current">
<li class="toctree-l1 current has-children"><a class="reference internal" href="../index.html">Kate’s Design Documents</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><div class="visually-hidden">Toggle navigation of Kate’s Design Documents</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">#F0001 — The LJT language</a></li>
<li class="toctree-l2"><a class="reference internal" href="F0002-kart.html">#F0002 — KART cartridges</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kernel/K0001-capabilities.html">#K0001 — Capabilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kernel/K0002-live-audit.html">#K0002 — Live auditing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kernel/K0003-resource-band.html">#K0003 — Resource band</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kernel/K0004-processes.html">#K0004 — Processes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kernel/K0005-partitioned-file-storage.html">#K0005 — Partitioned File Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kernel/K0006-cartridge-signatures.html">#K0006 — Cartridge signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kernel/K0007-key-store.html">#K0007 — Secure key store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/A0001-object-storage.html">#A0001 — Object Store API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/A0002-external-url.html">#A0002 — External URL navigation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/A0003-device-file-access.html">#A0003 — Device file access</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Changes, Terms, and Credits</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../etc/releases/index.html">Release notes</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><div class="visually-hidden">Toggle navigation of Release notes</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../etc/releases/0.25.html">Kate v0.25  (Spring 2024)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../etc/releases/0.23.10.html">Kate v0.23.10  (October 2023)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../etc/releases/0.23.8.html">Kate v0.23.8  (August 2023)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../etc/releases/0.23.6.html">Kate v0.23.6  (June 2023)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../etc/releases/0.23.5.html">Kate v0.23.5  (May 2023)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../etc/releases/0.23.4.html">Kate v0.23.4  (April 2023)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../etc/licence.html">Terms of use</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Indices and Tables</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../py-modindex.html">Module Index</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="edit-this-page">
  <a class="muted-link" href="https://github.com/qteatime/kate/edit/main/docs/source/design/formats/F0001-ljt.rst" title="Edit this page">
    <svg aria-hidden="true" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
      <line x1="13.5" y1="6.5" x2="17.5" y2="10.5" />
    </svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="f0001-the-ljt-language">
<h1>#F0001 — The LJT language<a class="headerlink" href="#f0001-the-ljt-language" title="Link to this heading">#</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd"><p>Niini</p>
</dd>
<dt class="field-even">Started<span class="colon">:</span></dt>
<dd class="field-even"><p>2023-12-30</p>
</dd>
<dt class="field-odd">Last updated<span class="colon">:</span></dt>
<dd class="field-odd"><p>2023-12-30</p>
</dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><p>Design in progress</p>
</dd>
</dl>
<section id="timeline">
<h2>Timeline<a class="headerlink" href="#timeline" title="Link to this heading">#</a></h2>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>First draft</p></th>
<th class="head"><p>Proof of Concept</p></th>
<th class="head"><p>Stable implementation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>2023-12-30</p></td>
<td><p>—</p></td>
<td><p>—</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h2>
<p>LJT is a programming language for specifying binary codecs. It’s used
extensively in both Kate and Crochet for all binary data needs, and designed
for rich data encoding (with sum types), packed binaries, integrity and
safety contracts, and schema evolution.</p>
<p>Unlike many other binary exchange formats, LJT is <strong>intentionally</strong> not
designed for random access and structures have neither a fixed size nor
fixed <em>version</em>.</p>
</section>
<section id="codec-formal-language">
<h2>Codec formal language<a class="headerlink" href="#codec-formal-language" title="Link to this heading">#</a></h2>
<p>LJT codecs uses a small language for encoding data, with types reminiscent of
Standard ML, with the small addition that they’re versioned. It can be
described as follows:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">id</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="n">identifiers</span><span class="p">;</span>
<span class="nf">v</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="n">versions</span><span class="p">;</span>
<span class="nf">tag</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="n">tags</span><span class="p">;</span>

<span class="nf">expr</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="n">array</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">map</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">optional</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">record</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">variant</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">)</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">bool</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">int8</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">int16</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">int64</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">uint8</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">uint16</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">uint32</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">uint64</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">float32</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">float64</span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">bigint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">raw</span><span class="o">-</span><span class="n">bytes</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">fixed</span><span class="w"> </span><span class="n">size</span>
<span class="w">        </span><span class="p">;</span>

<span class="nf">declaration</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="n">id</span><span class="o">@</span><span class="n">v</span><span class="w"> </span><span class="p">(</span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">eN</span><span class="p">)</span>
<span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="n">union</span><span class="w"> </span><span class="n">id</span><span class="o">@</span><span class="n">v</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="kt">:</span><span class="w"> </span><span class="p">(</span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">eN</span><span class="p">),</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="kt">N:</span><span class="w"> </span><span class="p">(</span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">eN</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">               </span><span class="n">invariant</span><span class="w"> </span><span class="p">``</span><span class="n">id</span><span class="o">@</span><span class="n">v</span><span class="p">``</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">unique</span><span class="p">;</span>

<span class="nf">schema</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">{</span><span class="n">magic</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">d1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">dN</span><span class="p">)};</span>
</pre></div>
</div>
<p>So we can declare record types, which hold a tuple of basic type expressions,
and union types, which hold a variant that is also a tuple of basic type
expressions. Both of these are versioned, so <code class="docutils literal notranslate"><span class="pre">point2d&#64;1</span></code> and <code class="docutils literal notranslate"><span class="pre">point2d&#64;2</span></code>
can hold entirely different type tuples or have entirely different tuple
sizes.</p>
<p>In the type expressions, in addition to the scalar types we also have
<code class="docutils literal notranslate"><span class="pre">array</span></code> of types and <code class="docutils literal notranslate"><span class="pre">map</span></code> of types, as well as pointers to defined
records and variants at a specific version. Arrays and maps are packed —
that is, they include the size and then pack all of their contents up to
that size. There’s no padding to allow for random access.</p>
<p>A schema specifies its magic (an arbitrary sequence of <em>bytes</em>), its version,
and a sequence of all top-level types declared in it. Schemas with the same
magic and version are also expected to match exactly in their declaration
list.</p>
<p>When executing a schema we have two execution goals: <strong>encoding</strong> and
<strong>decoding</strong>. Both are described below:</p>
<section id="encoding">
<h3>Encoding<a class="headerlink" href="#encoding" title="Link to this heading">#</a></h3>
<p>Encoding proceeds in the following operational semantics:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="c1">-- that is, the slice of the number using little-endian encoding</span>
<span class="nf">s</span><span class="p">(</span><span class="n">a</span><span class="o">..</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">[]</span><span class="p">;</span>
<span class="nf">s</span><span class="p">(</span><span class="n">a</span><span class="o">..</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">[(</span><span class="n">n</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="mi">8</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="n">s</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="o">..</span><span class="n">b</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)];</span>

<span class="c1">-- encoding takes a typed value and an environment mapping `[id, v] -&gt; d`</span>
<span class="nf">e</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">bool</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">[</span><span class="kr">if</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="mh">0x01</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="mh">0x00</span><span class="p">];</span>

<span class="nf">e</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">int8</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="p">];</span>
<span class="nf">e</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">int16</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">s</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>
<span class="nf">e</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">int32</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">s</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>
<span class="nf">e</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">int64</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">s</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>

<span class="nf">e</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">uint8</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="p">];</span>
<span class="nf">e</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">uint16</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">s</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>
<span class="nf">e</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">uint32</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">s</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>
<span class="nf">e</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">uint64</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">s</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>

<span class="nf">e</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">to</span><span class="o">-</span><span class="n">ieee754</span><span class="o">-</span><span class="n">binary</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">);</span>
<span class="nf">e</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">float64</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">to</span><span class="o">-</span><span class="n">ieee754</span><span class="o">-</span><span class="n">binary</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">);</span>

<span class="nf">e</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">bigint</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="p">[</span><span class="n">e</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span><span class="w"> </span><span class="n">e</span><span class="p">(</span><span class="n">ceil</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">uint32</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span><span class="w"> </span><span class="o">...</span><span class="n">s</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="n">ceil</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">256</span><span class="p">),</span><span class="w"> </span><span class="n">x</span><span class="p">)];</span>

<span class="nf">e</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="p">[</span><span class="n">e</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">length</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">uint32</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span><span class="w"> </span><span class="o">...</span><span class="n">utf8</span><span class="p">(</span><span class="n">x</span><span class="p">)];</span>

<span class="nf">e</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">raw</span><span class="o">-</span><span class="n">bytes</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="p">[</span><span class="n">e</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">length</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">uint32</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span><span class="w"> </span><span class="o">...</span><span class="n">x</span><span class="p">];</span>

<span class="nf">e</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">optional</span><span class="o">.</span><span class="n">some</span><span class="p">(</span><span class="n">v</span><span class="p">),</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="p">[</span><span class="n">e</span><span class="p">(</span><span class="n">true</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span><span class="w"> </span><span class="o">...</span><span class="n">e</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)];</span>

<span class="nf">e</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">optional</span><span class="o">.</span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="p">[</span><span class="n">e</span><span class="p">(</span><span class="n">false</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)];</span>

<span class="nf">e</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">array</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">tN</span><span class="p">),</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="p">[</span><span class="n">e</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">length</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">uint32</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span><span class="w"> </span><span class="n">e</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">(</span><span class="n">tN</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)];</span>

<span class="nf">e</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">map</span><span class="p">(</span><span class="n">k1</span><span class="kt">:</span><span class="w"> </span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">kN</span><span class="kt">:</span><span class="w"> </span><span class="n">vN</span><span class="p">),</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="p">[</span><span class="n">e</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">length</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">uint32</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span><span class="w"> </span><span class="n">e</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span><span class="w"> </span><span class="n">e</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">(</span><span class="n">kN</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span><span class="w"> </span><span class="n">e</span><span class="p">(</span><span class="n">vN</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)];</span>

<span class="nf">e</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">record</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">),</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">fN</span><span class="p">)</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kt">E</span><span class="p">[</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">]</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="p">[</span><span class="n">e</span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">uint32</span><span class="p">),</span><span class="w"> </span><span class="n">e</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">(</span><span class="n">fN</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)];</span>

<span class="nf">e</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">variant</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">),</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">fN</span><span class="p">)</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kt">E</span><span class="p">[</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">][</span><span class="n">tag</span><span class="p">]</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="p">[</span><span class="n">e</span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">uint32</span><span class="p">),</span><span class="w"> </span><span class="n">e</span><span class="p">(</span><span class="n">tag</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">uint32</span><span class="p">),</span><span class="w"> </span><span class="n">e</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">(</span><span class="n">fN</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)];</span>
</pre></div>
</div>
<p>Broadly:</p>
<ul class="simple">
<li><p>Booleans are encoded in a single <strong>byte</strong>. <code class="docutils literal notranslate"><span class="pre">0</span></code> denotes false, all other
values denote true (though conventionally <code class="docutils literal notranslate"><span class="pre">1</span></code> is used).</p></li>
<li><p>Numbers are encoded in a fixed number of bytes using little-endian encoding.</p></li>
<li><p>Floating points are taken to follow the IEEE-754 encoding for 32 and 64 bit
binary representations, and are not defined here. Please
<a class="reference external" href="https://ieeexplore.ieee.org/document/8766229">refer to the IEEE-754 specification for details instead</a>.</p></li>
<li><p>Arbitrary-precision integers are encoded just as their sign, followed
by the number of required bytes, followed by all bytes that make up the number,
in little-endian encoding. Note that the sign takes one whole byte — it’s
encoded in the same manner as <code class="docutils literal notranslate"><span class="pre">boolean</span></code>.</p></li>
<li><p>Text is encoded as raw UTF-8 bytes, preceded by the number of bytes that it
requires as a uint32LE number.</p></li>
<li><p>Likewise, raw-bytes are encoded as is, but preceded by the number of bytes
as a uint32LE number.</p></li>
<li><p>Optionals are encoded with a boolean representing the presence or absence
of the value, followed by the packed encoding of the value if it’s present.</p></li>
<li><p>Arrays start with the number of elements as a uint32LE number, and are
followed by the packed encoding of each of its values. There’s no padding
added, so items cannot be accessed by byte offsets in this format.</p></li>
<li><p>Maps, like arrays, start with the number of elements as a uint32LE number,
and are followed by the packed encoding of the key, and the packed encoding
of that key’s value. There’s no padding added, so again items cannot be
accessed by byte offsets in this format.</p></li>
<li><p>Records are encoded <strong>by their version</strong>, as a uint32LE number, followed
by the packed encoding of their fields in order. Note that there’s no
identifier specifying what the record is because LJT <strong>requires</strong> a schema
for both encoding and decoding.</p></li>
<li><p>Unions are encoded <strong>by the version and variant tag</strong>, as two uint32LE numbers,
followed by the packed encoding of that variant’s fields in order. This is
because only the union is versioned, not individual variants, and unions
may remove or add variants in different versions. Again, no identifier for
the union is provided, so a schema is required for decoding.</p></li>
</ul>
</section>
<section id="decoding">
<h3>Decoding<a class="headerlink" href="#decoding" title="Link to this heading">#</a></h3>
<p>Decoding follows the reverse process of encoding, and is captured in the
following operational semantics:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="c1">-- that is, putting together the number from little-endian bytes</span>
<span class="nf">s</span><span class="p">(</span><span class="kt">[]</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="mi">0</span>
<span class="nf">s</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="n">b</span><span class="p">],</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="mi">8</span><span class="p">))</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">s</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="c1">-- decoding does not require an environment, but it requires a target type</span>
<span class="nf">d</span><span class="p">(</span><span class="n">bool</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">])</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]);</span>

<span class="nf">d</span><span class="p">(</span><span class="n">int8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">])</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">int8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]);</span>
<span class="nf">d</span><span class="p">(</span><span class="n">int16</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">])</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">])</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">int16</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]);</span>
<span class="nf">d</span><span class="p">(</span><span class="n">int32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">])</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">])</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">int32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]);</span>
<span class="nf">d</span><span class="p">(</span><span class="n">int64</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">])</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">])</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">int64</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]);</span>

<span class="nf">d</span><span class="p">(</span><span class="n">uint8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">])</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]);</span>
<span class="nf">d</span><span class="p">(</span><span class="n">uint16</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">])</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">]),</span><span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]);</span>
<span class="nf">d</span><span class="p">(</span><span class="n">uint32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">])</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">]),</span><span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]);</span>
<span class="nf">d</span><span class="p">(</span><span class="n">uint64</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">])</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">]),</span><span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]);</span>

<span class="nf">d</span><span class="p">(</span><span class="n">float32</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">])</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="p">(</span><span class="n">from</span><span class="o">-</span><span class="n">iee754</span><span class="o">-</span><span class="n">binary</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">],</span><span class="w"> </span><span class="mi">32</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]);</span>
<span class="nf">d</span><span class="p">(</span><span class="n">float64</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">])</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="p">(</span><span class="n">from</span><span class="o">-</span><span class="n">iee754</span><span class="o">-</span><span class="n">binary</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">],</span><span class="w"> </span><span class="mi">64</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]);</span>

<span class="nf">d</span><span class="p">(</span><span class="n">bigint</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">negative</span><span class="p">,</span><span class="w"> </span><span class="kt">N</span><span class="p">,</span><span class="w"> </span><span class="n">b1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="kr">_</span><span class="p">,</span><span class="w"> </span><span class="n">bN</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">])</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="p">(</span><span class="w"> </span><span class="p">((</span><span class="n">b1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">...</span><span class="kr">_</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">bN</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">((</span><span class="kt">N</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="p">)))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">d</span><span class="p">(</span><span class="n">bool</span><span class="p">,</span><span class="w"> </span><span class="n">negative</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]);</span>

<span class="nf">d</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="kt">N</span><span class="p">,</span><span class="w"> </span><span class="n">b1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="kr">_</span><span class="p">,</span><span class="w"> </span><span class="n">bN</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">])</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="p">(</span><span class="n">from</span><span class="o">-</span><span class="n">utf8</span><span class="p">([</span><span class="n">b1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="kr">_</span><span class="p">,</span><span class="w"> </span><span class="n">bN</span><span class="p">]),</span><span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]);</span>

<span class="nf">d</span><span class="p">(</span><span class="n">raw</span><span class="o">-</span><span class="n">bytes</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="kt">N</span><span class="p">,</span><span class="w"> </span><span class="n">b1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="kr">_</span><span class="p">,</span><span class="w"> </span><span class="n">bN</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">])</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="p">([</span><span class="n">b1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">bN</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]);</span>

<span class="nf">d</span><span class="p">(</span><span class="n">optional</span><span class="p">(</span><span class="n">t</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">])</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="n">optional</span><span class="o">.</span><span class="n">just</span><span class="p">(</span><span class="n">d</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">))</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="n">optional</span><span class="o">.</span><span class="n">none</span><span class="p">;</span>

<span class="nf">d</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">t</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="kt">N</span><span class="p">,</span><span class="w"> </span><span class="n">b1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="kr">_</span><span class="p">,</span><span class="w"> </span><span class="n">bN</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">])</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="kt">N</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">b1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="kr">_</span><span class="p">,</span><span class="w"> </span><span class="n">bN</span><span class="p">]),</span><span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">])</span>
<span class="w">  </span><span class="kr">where</span><span class="w"> </span><span class="n">g</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kt">[]</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">[]</span><span class="p">;</span>
<span class="w">        </span><span class="n">g</span><span class="p">(</span><span class="kt">N</span><span class="p">,</span><span class="w"> </span><span class="n">bs</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">let</span><span class="w"> </span><span class="p">(</span><span class="kt">V</span><span class="p">,</span><span class="w"> </span><span class="kt">R</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">d</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">bs</span><span class="p">)</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="p">[</span><span class="kt">V</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="n">g</span><span class="p">(</span><span class="kt">N</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kt">R</span><span class="p">)];</span>

<span class="nf">d</span><span class="p">(</span><span class="n">map</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="kt">N</span><span class="p">,</span><span class="w"> </span><span class="n">b1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="kr">_</span><span class="p">,</span><span class="w"> </span><span class="n">bN</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">])</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="kt">N</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">b1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="kr">_</span><span class="p">,</span><span class="w"> </span><span class="n">bN</span><span class="p">]),</span><span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">])</span>
<span class="w">  </span><span class="kr">where</span><span class="w"> </span><span class="n">g</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kt">[]</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">[</span><span class="kt">:</span><span class="p">];</span>
<span class="w">        </span><span class="n">g</span><span class="p">(</span><span class="kt">N</span><span class="p">,</span><span class="w"> </span><span class="n">bs</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">let</span><span class="w"> </span><span class="p">(</span><span class="kt">K</span><span class="p">,</span><span class="w"> </span><span class="kt">R1</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">d</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">bs</span><span class="p">)</span><span class="w"> </span><span class="kr">in</span>
<span class="w">                   </span><span class="kr">let</span><span class="w"> </span><span class="p">(</span><span class="kt">V</span><span class="p">,</span><span class="w"> </span><span class="kt">R2</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">d</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="kt">R1</span><span class="p">)</span><span class="w"> </span><span class="kr">in</span>
<span class="w">                   </span><span class="p">[</span><span class="kt">K:</span><span class="w"> </span><span class="kt">V</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="n">g</span><span class="p">(</span><span class="kt">N</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kt">R2</span><span class="p">)];</span>

<span class="nf">d</span><span class="p">(</span><span class="o">&lt;</span><span class="n">record</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">fN</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">v</span><span class="o">&lt;</span><span class="n">uint32</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="kt">R0</span><span class="p">])</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="p">(</span><span class="kt">F1</span><span class="p">,</span><span class="w"> </span><span class="kt">R1</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">d</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="w"> </span><span class="kt">R0</span><span class="p">)</span><span class="w"> </span><span class="kr">in</span>
<span class="w">  </span><span class="o">...</span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="p">(</span><span class="kt">FN</span><span class="p">,</span><span class="w"> </span><span class="kt">RN</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">d</span><span class="p">(</span><span class="n">fN</span><span class="p">,</span><span class="w"> </span><span class="kt">R</span><span class="p">{</span><span class="kt">N</span><span class="o">-</span><span class="mi">1</span><span class="p">}))</span><span class="w"> </span><span class="kr">in</span>
<span class="w">  </span><span class="p">(</span><span class="o">&lt;</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">F1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="kt">FN</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="kt">RN</span><span class="p">);</span>

<span class="nf">d</span><span class="p">(</span><span class="o">&lt;</span><span class="n">union</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">)</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">fN</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">v</span><span class="o">&lt;</span><span class="n">uint32</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="o">&lt;</span><span class="n">uint32</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="kt">R0</span><span class="p">])</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="p">(</span><span class="kt">F1</span><span class="p">,</span><span class="w"> </span><span class="kt">R1</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">d</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="w"> </span><span class="kt">R0</span><span class="p">)</span><span class="w"> </span><span class="kr">in</span>
<span class="w">  </span><span class="o">...</span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="p">(</span><span class="kt">FN</span><span class="p">,</span><span class="w"> </span><span class="kt">RN</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">d</span><span class="p">(</span><span class="n">fN</span><span class="p">,</span><span class="w"> </span><span class="kt">R</span><span class="p">{</span><span class="kt">N</span><span class="o">-</span><span class="mi">1</span><span class="p">})</span><span class="w"> </span><span class="kr">in</span>
<span class="w">  </span><span class="p">(</span><span class="o">&lt;</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">F1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="kt">FN</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="kt">RN</span><span class="p">);</span>
</pre></div>
</div>
<p>So decoding is mostly straightforward: take the target type, decode the first
bytes according to that type’s specification, then return the decoded value
along with the remaining bytes.</p>
<p>Where it requires a bit more of attention is in decoding records and variants.
The schema only specifies the id of the record or union that can be encoded
at a specific point, so the decoder must first decode the version (and tag,
in case of a union) to find the specific type that is to be used when decoding
the following bytes.</p>
<p>For example, consider:</p>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="kr">type</span><span class="w"> </span><span class="nx">Point</span><span class="err">@</span><span class="mf">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">field</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">Uint32</span><span class="p">;</span><span class="w"> </span><span class="nx">field</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">Uint32</span><span class="w"> </span><span class="p">}</span><span class="w">                   </span><span class="c1">// id: 0</span>
<span class="kr">type</span><span class="w"> </span><span class="nx">Point</span><span class="err">@</span><span class="mf">1</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">field</span><span class="w"> </span><span class="nx">x</span><span class="o">:</span><span class="w"> </span><span class="kt">Uint32</span><span class="p">;</span><span class="w"> </span><span class="nx">field</span><span class="w"> </span><span class="nx">y</span><span class="o">:</span><span class="w"> </span><span class="kt">Uint32</span><span class="p">;</span><span class="w"> </span><span class="nx">field</span><span class="w"> </span><span class="nx">z</span><span class="o">:</span><span class="w"> </span><span class="kt">Uint32</span><span class="w"> </span><span class="p">}</span><span class="w">  </span><span class="c1">// id: 0</span>

<span class="kr">type</span><span class="w"> </span><span class="nx">Player</span><span class="err">@</span><span class="mf">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">field</span><span class="w"> </span><span class="nx">position</span><span class="o">:</span><span class="w"> </span><span class="kt">Point</span><span class="w"> </span><span class="p">}</span><span class="w">                             </span><span class="c1">// id: 1</span>
</pre></div>
</div>
<p>If we encode the player value <code class="docutils literal notranslate"><span class="pre">Player({</span> <span class="pre">x:</span> <span class="pre">0,</span> <span class="pre">y:</span> <span class="pre">0</span> <span class="pre">})</span></code>, that will have
a distinct binary representation from encoding <code class="docutils literal notranslate"><span class="pre">Player({</span> <span class="pre">x:</span> <span class="pre">0,</span> <span class="pre">y:</span> <span class="pre">0,</span> <span class="pre">z:</span> <span class="pre">0</span> <span class="pre">})</span></code>,
but the schema only says “use <code class="docutils literal notranslate"><span class="pre">Point</span></code> to decode this”.</p>
<p>Putting it in more concrete terms:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>encode(Player({x: 0, y: 0 }))
= [1&lt;u32&gt;, 0&lt;u32&gt;, 0&lt;u32&gt;, 0&lt;u32&gt;, 0&lt;u32&gt;]
   |       |       |       `-------------&gt; Point fields
   |       |       `--&gt; Point version
   |       `--&gt; Player version
   `--&gt; Player id

encode(Player({ x: 0, y: 0, z: 0 ))
= [1&lt;u32&gt;, 0&lt;u32&gt;, 1&lt;u32&gt;, 0&lt;u32&gt;, 0&lt;u32&gt;, 0&lt;u32&gt;]

decode([1&lt;u32&gt;, 0&lt;u32&gt;, 0&lt;u32&gt;, 0&lt;u32&gt;, 0&lt;u32&gt;])
= Player@0(Point@0(x: 0, y: 0))

decode([1&lt;u32&gt;, 0&lt;u32&gt;, 1&lt;u32&gt;, 0&lt;u32&gt;, 0&lt;u32&gt;, 0&lt;u32&gt;])
= Player@0(Point@1(x: 0, y: 0, z: 0))
</pre></div>
</div>
</section>
<section id="codec-invariants">
<h3>Codec invariants<a class="headerlink" href="#codec-invariants" title="Link to this heading">#</a></h3>
<p>The algorithm specified enjoys the property that <code class="docutils literal notranslate"><span class="pre">d(e(v,</span> <span class="pre">E),</span> <span class="pre">T)</span> <span class="pre">=</span> <span class="pre">v</span></code> always
holds given the correct environment and target type.</p>
<p>Likewise, <code class="docutils literal notranslate"><span class="pre">e(d(bytes,</span> <span class="pre">T),</span> <span class="pre">E)</span> <span class="pre">=</span> <span class="pre">bytes</span></code> always holds given the correct
environment and target type.</p>
</section>
<section id="top-level-encoding-and-decoding">
<h3>Top-level encoding and decoding<a class="headerlink" href="#top-level-encoding-and-decoding" title="Link to this heading">#</a></h3>
<p>The encoding and decoding algorithms specified in the sections above refer
only to individual expressions. There is additional data and operations
involved when we encode or decode from the top-level. This is because a
LJT schema does not prescribe any canonical type to start encoding/decoding
from, and thus it can start from any given <strong>record</strong> type.</p>
<p>This is captured in the following operational semantics:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">top</span><span class="o">-</span><span class="n">encode</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">magic</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">record</span><span class="w"> </span><span class="n">id</span><span class="o">@</span><span class="n">version</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">T</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">E</span><span class="p">})</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="p">[</span>
<span class="w">    </span><span class="o">...</span><span class="n">magic</span><span class="p">,</span>
<span class="w">    </span><span class="n">e</span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">uint32</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span>
<span class="w">    </span><span class="n">e</span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">uint32</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span>
<span class="w">    </span><span class="n">e</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="kt">T</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span>
<span class="w">  </span><span class="p">];</span>

<span class="nf">top</span><span class="o">-</span><span class="n">decode</span><span class="p">(</span>
<span class="w">  </span><span class="p">[</span><span class="o">...</span><span class="n">magic</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="o">&lt;</span><span class="n">uint32</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="o">&lt;</span><span class="n">uint32</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="o">&lt;</span><span class="n">uint32</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="kr">data</span><span class="p">],</span>
<span class="w">  </span><span class="n">id</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="n">magic</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">record</span><span class="w"> </span><span class="n">id</span><span class="o">@</span><span class="n">version</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">T</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">)}</span>
<span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">d</span><span class="p">(</span><span class="o">&lt;</span><span class="n">record</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="p">),</span><span class="w"> </span><span class="kt">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="n">version</span><span class="p">,</span><span class="w"> </span><span class="kr">data</span><span class="p">]);</span>
</pre></div>
</div>
<p>Which is to say, a top-level encoding includes the magic and version header
for the schema as well, and the identifier for the record that should be used
when decoding it. The <em>version</em> of that record is included by the regular
encoder, because individual values in the encoded blob can be at different
versions of the same record type.</p>
<p>Decoding peeks at the magic header and picks the record type with the specified
id and version to know which specific target type is to be used when decoding.
This frees the user from worrying about how to figure out the version; that’s
handled automatically from the LJT side.</p>
</section>
</section>
<section id="schema-evolution">
<h2>Schema evolution<a class="headerlink" href="#schema-evolution" title="Link to this heading">#</a></h2>
<p>To support schema evolution LJT subscribes to the idea of versioned objects
with patching semantics—similar to how database migrations work. Patches
can specify upgrade semantics such that it’s possible to decode
older versions of data <em>and</em> treat them as the latest version anyway, avoiding
complex and error-prone versioning in the actual program code.</p>
<p>Patches are applied after decoding, so there are no changes needed to the
decoding process itself—decoding already takes versioning into account,
and properly decodes multiple versions of the same type. Again, patches are
only meant to reduce the complexity of programs working with versioned data.</p>
<section id="formal-semantics">
<h3>Formal semantics<a class="headerlink" href="#formal-semantics" title="Link to this heading">#</a></h3>
<p>Patching semantics are captured by the following formal language:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">l</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="n">labels</span>
<span class="nf">x</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="n">variables</span>
<span class="nf">f</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="n">functions</span>
<span class="nf">b</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="n">booleans</span>
<span class="nf">i</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="n">integer</span>
<span class="nf">t</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="n">text</span>
<span class="nf">rb</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="n">raw</span><span class="o">-</span><span class="n">bytes</span>

<span class="kt">PatchExpr</span><span class="w"> </span><span class="n">pe</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="n">old</span><span class="w">                 </span><span class="c1">-- the old object</span>
<span class="w">              </span><span class="o">|</span><span class="w"> </span><span class="n">pe</span><span class="o">.</span><span class="n">l</span><span class="w">                </span><span class="c1">-- projection</span>
<span class="w">              </span><span class="o">|</span><span class="w"> </span><span class="p">[</span><span class="n">pe</span><span class="o">...</span><span class="p">]</span><span class="w">             </span><span class="c1">-- arrays</span>
<span class="w">              </span><span class="o">|</span><span class="w"> </span><span class="p">[</span><span class="n">pe</span><span class="kt">:</span><span class="w"> </span><span class="n">pe</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">]</span><span class="w">       </span><span class="c1">-- maps</span>
<span class="w">              </span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">pe</span><span class="o">...</span><span class="p">)</span><span class="w">            </span><span class="c1">-- primitive/foreign call</span>
<span class="w">              </span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="w">                   </span><span class="c1">-- variable dereference</span>
<span class="w">              </span><span class="o">|</span><span class="w"> </span><span class="kr">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">pe</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="n">pe</span><span class="w">    </span><span class="c1">-- local bindings</span>
<span class="w">              </span><span class="o">|</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">rb</span><span class="w">      </span><span class="c1">-- constants</span>

<span class="kt">Patch</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="n">upgrade</span><span class="o">-</span><span class="n">record</span><span class="p">(</span><span class="n">id</span><span class="o">@</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">pe1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">peN</span><span class="p">))</span>
<span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">upgrade</span><span class="o">-</span><span class="n">variant</span><span class="p">(</span><span class="n">id</span><span class="o">@</span><span class="n">v</span><span class="o">@</span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">new</span><span class="o">-</span><span class="n">tag</span><span class="w"> </span><span class="p">(</span><span class="n">pe1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">peN</span><span class="p">))</span>

<span class="kt">Patches</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">[</span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">pN</span><span class="p">]</span>
</pre></div>
</div>
<p>In essence, the decoded tree is passed to the patching function, which
recurses down the tree and applies upgrade patches one-by-one to all
records that can be upgraded. An upgrade is guaranteed to succeed,
and guaranteed to yield a value of the same type with the complete
shape defined — this is captured by <code class="docutils literal notranslate"><span class="pre">Patch</span></code> instructions specifying
the whole shape of the object. Patches <strong>must</strong> be type-checked.</p>
<p>Execution of patches is captured by the following operational semantics:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">patch</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">any</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>

<span class="nf">patch</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">optional</span><span class="o">.</span><span class="n">just</span><span class="p">(</span><span class="n">v</span><span class="p">),</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">optional</span><span class="o">.</span><span class="n">just</span><span class="p">(</span><span class="n">patch</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">));</span>

<span class="nf">patch</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">array</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">aN</span><span class="p">),</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">array</span><span class="p">(</span><span class="n">patch</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">patch</span><span class="p">(</span><span class="n">aN</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">));</span>

<span class="nf">patch</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">map</span><span class="p">(</span><span class="n">k1</span><span class="kt">:</span><span class="w"> </span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">kN</span><span class="kt">:</span><span class="w"> </span><span class="n">vN</span><span class="p">]))</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">map</span><span class="p">(</span><span class="n">patch</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="kt">:</span><span class="w"> </span><span class="n">patch</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">patch</span><span class="p">(</span><span class="n">kN</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="kt">:</span><span class="w"> </span><span class="n">patch</span><span class="p">(</span><span class="n">vN</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">));</span>

<span class="nf">patch</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">record</span><span class="p">(</span><span class="o">&lt;</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">fN</span><span class="p">)),</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">fN</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">(</span><span class="n">patch</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">patch</span><span class="p">(</span><span class="n">fN</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">))</span><span class="w"> </span><span class="kr">in</span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">fN</span><span class="p">)</span><span class="w"> </span><span class="kr">in</span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="p">(</span><span class="n">pe1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">peN</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">E</span><span class="o">.</span><span class="n">patches</span><span class="p">[</span><span class="n">id</span><span class="p">][</span><span class="n">v</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="kr">in</span>
<span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="n">patch</span><span class="w"> </span><span class="n">exists</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="n">patch</span><span class="p">(</span><span class="n">record</span><span class="p">(</span><span class="o">&lt;</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">eval</span><span class="p">(</span><span class="n">pe1</span><span class="p">,</span><span class="w"> </span><span class="n">old</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">eval</span><span class="p">(</span><span class="n">peN</span><span class="p">,</span><span class="w"> </span><span class="n">old</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">))),</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span>
<span class="w">  </span><span class="kr">else</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="n">record</span><span class="p">(</span><span class="o">&lt;</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">fN</span><span class="p">));</span>

<span class="nf">patch</span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">variant</span><span class="p">(</span><span class="o">&lt;</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">fN</span><span class="p">)),</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">fN</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">(</span><span class="n">patch</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">patch</span><span class="p">(</span><span class="n">fN</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">))</span><span class="w"> </span><span class="kr">in</span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">fN</span><span class="p">)</span><span class="w"> </span><span class="kr">in</span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="n">new</span><span class="o">-</span><span class="n">tag</span><span class="p">(</span><span class="n">pe1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">peN</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">E</span><span class="o">.</span><span class="n">patches</span><span class="p">[</span><span class="n">id</span><span class="p">][</span><span class="n">v</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="kr">in</span>
<span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="n">patch</span><span class="w"> </span><span class="n">exists</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="n">patch</span><span class="p">(</span><span class="n">variant</span><span class="p">(</span><span class="o">&lt;</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">new</span><span class="o">-</span><span class="n">tag</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">eval</span><span class="p">(</span><span class="n">pe1</span><span class="p">,</span><span class="w"> </span><span class="n">old</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">eval</span><span class="p">(</span><span class="n">peN</span><span class="p">,</span><span class="w"> </span><span class="n">old</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">))),</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span>
<span class="w">  </span><span class="kr">else</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="n">variant</span><span class="p">(</span><span class="o">&lt;</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">fN</span><span class="p">));</span>
</pre></div>
</div>
<p>Where evaluation of the patch expressions themselves follows what you’d expect
of a pure call-by-value expression language:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">eval</span><span class="p">(</span><span class="n">old</span><span class="p">,</span><span class="w"> </span><span class="kt">X</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">X</span><span class="p">;</span>

<span class="nf">eval</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="kt">X</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">eval</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="kt">X</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="o">.</span><span class="n">l</span><span class="p">;</span>

<span class="nf">eval</span><span class="p">([</span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">eN</span><span class="p">],</span><span class="w"> </span><span class="kt">X</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="p">[</span><span class="n">eval</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="kt">X</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">eval</span><span class="p">(</span><span class="n">eN</span><span class="p">,</span><span class="w"> </span><span class="kt">X</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)];</span>

<span class="nf">eval</span><span class="p">([</span><span class="n">k1</span><span class="kt">:</span><span class="w"> </span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">kN</span><span class="kt">:</span><span class="w"> </span><span class="n">eN</span><span class="p">],</span><span class="w"> </span><span class="kt">X</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="p">[</span><span class="n">eval</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span><span class="w"> </span><span class="kt">X</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="kt">:</span><span class="w"> </span><span class="n">eval</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="kt">X</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">eval</span><span class="p">(</span><span class="n">kN</span><span class="p">,</span><span class="w"> </span><span class="kt">X</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="kt">:</span><span class="w"> </span><span class="n">eval</span><span class="p">(</span><span class="n">eN</span><span class="p">,</span><span class="w"> </span><span class="kt">X</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)];</span>

<span class="nf">eval</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">eN</span><span class="p">),</span><span class="w"> </span><span class="kt">X</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="kt">E</span><span class="o">.</span><span class="n">funs</span><span class="p">[</span><span class="n">f</span><span class="p">](</span><span class="n">eval</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="kt">X</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">eval</span><span class="p">(</span><span class="n">eN</span><span class="p">,</span><span class="w"> </span><span class="kt">X</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">));</span>

<span class="nf">eval</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">X</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="kt">E</span><span class="o">.</span><span class="n">vars</span><span class="p">[</span><span class="n">x</span><span class="p">];</span>

<span class="nf">eval</span><span class="p">(</span><span class="kr">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">e1</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="n">e2</span><span class="p">,</span><span class="w"> </span><span class="kt">X</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">eval</span><span class="p">(</span><span class="n">e2</span><span class="p">,</span><span class="w"> </span><span class="kt">X</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">{</span><span class="n">vars</span><span class="kt">:</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">eval</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="kt">X</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">),</span><span class="w"> </span><span class="o">...</span><span class="kt">E</span><span class="o">.</span><span class="n">vars</span><span class="p">]});</span>

<span class="nf">eval</span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">rb</span><span class="p">,</span><span class="w"> </span><span class="kt">X</span><span class="p">,</span><span class="w"> </span><span class="kt">E</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">rb</span><span class="p">;</span>
</pre></div>
</div>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="F0002-kart.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">#F0002 — KART cartridges</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../index.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Kate’s Design Documents</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023-2024, Niini
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">#F0001 — The LJT language</a><ul>
<li><a class="reference internal" href="#timeline">Timeline</a></li>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#codec-formal-language">Codec formal language</a><ul>
<li><a class="reference internal" href="#encoding">Encoding</a></li>
<li><a class="reference internal" href="#decoding">Decoding</a></li>
<li><a class="reference internal" href="#codec-invariants">Codec invariants</a></li>
<li><a class="reference internal" href="#top-level-encoding-and-decoding">Top-level encoding and decoding</a></li>
</ul>
</li>
<li><a class="reference internal" href="#schema-evolution">Schema evolution</a><ul>
<li><a class="reference internal" href="#formal-semantics">Formal semantics</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=594d7d3c"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=32e29ea5"></script>
    </body>
</html>