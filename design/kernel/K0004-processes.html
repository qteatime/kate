<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><link rel="next" title="#K0005 — Partitioned File Storage" href="K0005-partitioned-file-storage.html" /><link rel="prev" title="#K0003 — Resource band" href="K0003-resource-band.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2023.09.10 -->
        <title>#K0004 — Processes - Kate 0.25 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=82a976d7" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=d1035e3f" />
    
    


<style>
  body {
    --color-code-background: #ffffff;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<div class="announcement">
  <aside class="announcement-content">
     Both Kate and this documentation are a work in progress and may change at any time. 
  </aside>
</div>

<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">Kate 0.25 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">Kate 0.25 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">End-user books</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../user/manual/index.html">The Kate User Manual</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of The Kate User Manual</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../user/manual/intro/index.html">Getting started</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Getting started</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/intro/hardware.html">Tech specs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/intro/emulator.html">Emulator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/intro/install.html">Installing</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../user/manual/gaming/index.html">Playing games</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Playing games</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/gaming/cartridges.html">ROM Cartridges</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/gaming/captures.html">Screen recording</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/gaming/save-data.html">Save data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/gaming/play-habits.html">Play habits</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/gaming/storage.html">Stored data</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../user/manual/security/index.html">Security and privacy</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of Security and privacy</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/security/philosophy.html">Safety philosophy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/security/sandboxing.html">Sandboxing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/security/privacy.html">Privacy policy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/security/trust.html">Trust and consent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/security/audit.html">Audit logs</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../user/importer/index.html">The Kate Importer Manual</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of The Kate Importer Manual</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../user/importer/renpy.html">Ren’Py</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user/importer/bitsy.html">Bitsy</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../user/diy/index.html">Build Your Own Console!</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Build Your Own Console!</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../user/diy/overview/index.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user/diy/hardware/index.html">The hardware</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Game developer books</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../dev/manual/index.html">Making games for Kate!</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of Making games for Kate!</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../dev/manual/intro/index.html">Getting started</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of Getting started</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/intro/why.html">Why make games for Kate?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/intro/setup.html">What will you need?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/intro/hello-world.html">Hello, World</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../dev/manual/model/index.html">Programming model</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of Programming model</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/model/overview.html">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/model/cartridges.html">Cartridges</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/model/sandboxing.html">Sandboxing and APIs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/model/capabilities.html">Capabilities</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../dev/manual/api/index.html">Kate API</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of Kate API</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/api/events.html"><code class="docutils literal notranslate"><span class="pre">events</span></code> — Event handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/api/cart-fs.html"><code class="docutils literal notranslate"><span class="pre">cart_fs</span></code> — Reading files</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/api/input.html"><code class="docutils literal notranslate"><span class="pre">*_input</span></code> — Reacting to player input</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/api/timer.html"><code class="docutils literal notranslate"><span class="pre">timer</span></code> — Scheduling updates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/api/capture.html"><code class="docutils literal notranslate"><span class="pre">capture</span></code> — Screenshots and video recording</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/api/store.html"><code class="docutils literal notranslate"><span class="pre">store</span></code> — Saving state</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/api/browser.html"><code class="docutils literal notranslate"><span class="pre">browser</span></code> — Navigating to URLs</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../dev/manual/web/index.html">Web game support</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle navigation of Web game support</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/web/basics.html">Basics of porting</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../dev/manual/web/bridges/index.html">Bridges</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle navigation of Bridges</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/network-proxy.html">Network proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/input-proxy.html">Button input proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/pointer-input-proxy.html">Pointer input proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/local-storage-proxy.html">Local storage proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/indexeddb-proxy.html">IndexedDB proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/external-url-handler.html">External URL handler</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/preserve-webgl-render.html">Preserve WebGL Render</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/capture-canvas.html">Capture canvas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/renpy-tweaks.html">Ren’Py tweaks</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../dev/manual/packing/index.html">Packaging cartridges</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle navigation of Packaging cartridges</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/packing/getting-started.html">Getting started</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/packing/configuration.html">Configuration files</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../dev/port/index.html">Kate Porting Recipes</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><div class="visually-hidden">Toggle navigation of Kate Porting Recipes</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../dev/port/bitsy.html">Bitsy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/port/renpy.html">Ren’Py</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/port/godot.html">Godot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/port/rpg-maker.html">RPG Maker MV</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/port/gamemaker.html">GameMaker</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Design and implementation</span></p>
<ul class="current">
<li class="toctree-l1 current has-children"><a class="reference internal" href="../index.html">Kate’s Design Documents</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><div class="visually-hidden">Toggle navigation of Kate’s Design Documents</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../formats/F0001-ljt.html">#F0001 — The LJT language</a></li>
<li class="toctree-l2"><a class="reference internal" href="../formats/F0002-kart.html">#F0002 — KART cartridges</a></li>
<li class="toctree-l2"><a class="reference internal" href="K0001-capabilities.html">#K0001 — Capabilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="K0002-live-audit.html">#K0002 — Live auditing</a></li>
<li class="toctree-l2"><a class="reference internal" href="K0003-resource-band.html">#K0003 — Resource band</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">#K0004 — Processes</a></li>
<li class="toctree-l2"><a class="reference internal" href="K0005-partitioned-file-storage.html">#K0005 — Partitioned File Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="K0006-cartridge-signatures.html">#K0006 — Cartridge signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="K0007-key-store.html">#K0007 — Secure key store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/A0001-object-storage.html">#A0001 — Object Store API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/A0002-external-url.html">#A0002 — External URL navigation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/A0003-device-file-access.html">#A0003 — Device file access</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Changes, Terms, and Credits</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../etc/releases/index.html">Release notes</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><div class="visually-hidden">Toggle navigation of Release notes</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../etc/releases/0.25.html">Kate v0.25  (Spring 2024)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../etc/releases/0.23.10.html">Kate v0.23.10  (October 2023)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../etc/releases/0.23.8.html">Kate v0.23.8  (August 2023)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../etc/releases/0.23.6.html">Kate v0.23.6  (June 2023)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../etc/releases/0.23.5.html">Kate v0.23.5  (May 2023)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../etc/releases/0.23.4.html">Kate v0.23.4  (April 2023)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../etc/licence.html">Terms of use</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Indices and Tables</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../py-modindex.html">Module Index</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="edit-this-page">
  <a class="muted-link" href="https://github.com/qteatime/kate/edit/main/docs/source/design/kernel/K0004-processes.rst" title="Edit this page">
    <svg aria-hidden="true" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
      <line x1="13.5" y1="6.5" x2="17.5" y2="10.5" />
    </svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="k0004-processes">
<h1>#K0004 — Processes<a class="headerlink" href="#k0004-processes" title="Link to this heading">#</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd"><p>Niini</p>
</dd>
<dt class="field-even">Started<span class="colon">:</span></dt>
<dd class="field-even"><p>2023-12-08</p>
</dd>
<dt class="field-odd">Last updated<span class="colon">:</span></dt>
<dd class="field-odd"><p>2023-12-08</p>
</dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><p>Design in progress</p>
</dd>
</dl>
<section id="timeline">
<h2>Timeline<a class="headerlink" href="#timeline" title="Link to this heading">#</a></h2>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>First draft</p></th>
<th class="head"><p>Proof of Concept</p></th>
<th class="head"><p>Stable implementation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>2023-12-08</p></td>
<td><p>—</p></td>
<td><p>—</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h2>
<p>Kate allows a user to install multiple applications in a single shared system,
and then launch those applications to operate on the system resources. It’s
important that we make sure these applications are properly isolated, and
that they can access the resources they need and have access to securely.</p>
<p>To that end Kate manages each of these launched applications as a “Process”,
and provides a secure channel for the process to communicate with the
kernel, resources, and with other applications.</p>
<p>Design-wise, processes in Kate are not too unlike those in other operating
systems, except for the fact that Kate is hosted, so the host operating
system (or Browser) manages the memory and time-sharing, while Kate only
manages output and resource access. This makes the kernel significantly
simpler.</p>
</section>
<section id="technical-summary">
<h2>Technical summary<a class="headerlink" href="#technical-summary" title="Link to this heading">#</a></h2>
<p>Kate has two distinct process objects, since it’s a layered operating system.
At the kernel layer you have <code class="docutils literal notranslate"><span class="pre">Process</span></code> (and <code class="docutils literal notranslate"><span class="pre">ProcessManager</span></code>), which provide
the basic operating capabilities of what it means to be a process.</p>
<p>Processes in the kernel layer only have basic output capabilities, but no
access to shared resources. This is because the kernel layer is similar to
a microkernel, and it does not do a lot.</p>
<p>At this layer, the main job of <code class="docutils literal notranslate"><span class="pre">Process</span></code> and <code class="docutils literal notranslate"><span class="pre">ProcessManager</span></code> is to create
a fully isolated area for the application code to run, and to provide a
secure channel that this particular application code can use to communicate
with the kernel, in a fully authenticated fashion.</p>
<p>For the Browser-based implementation, isolation is provided by a sandboxed
iframe with no powerful capabilities. Authenticated messaging is provided
by exchanging <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/API/MessageChannel">MessagePorts</a>
in a straightforward handshake.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ProcessManager</span></code> keeps track of which processes are running at any given
time and provides resolution to process objects by their unique identifier,
but it doesn’t do more than that.</p>
<p>At the trusted-space layer, we have <code class="docutils literal notranslate"><span class="pre">KateProcesses</span></code>. This service handles
spawning processes in the kernel layer and starting up the process
(adding it to the screen, setting up the IPC handlers, starting up the
play time tracking, providing a way of reading files, etc).</p>
<p>Because processes run isolated, they must send a message to the kernel
every time they wish to do something outside of basic output capabilities.
This goes also for things like reading files that the application owns.
Messages must provide a unique identifier, which the trusted-layer side
uses to reply to. Any further coordination and evaluation of the message
happens in the trusted-space layer.</p>
<p>This gives rise to the following topology:</p>
<img alt="../../_images/process-topology.svg" src="../../_images/process-topology.svg" /><section id="spawning-phase">
<h3>Spawning phase<a class="headerlink" href="#spawning-phase" title="Link to this heading">#</a></h3>
<p>Processes start their lifecycle by being spawned — the kernel will allocate
an isolated frame for them to run, and then load the application’s startup
code in this frame.</p>
<p>Application code is linked to the Kate API (and potentially any bridges)
before being loaded in the frame. And it is up to the Kate API to set up
the application side of the IPC.</p>
<p>This is also the point where we decide which files the process will have
access to, by providing a layered file system to the process. Currently
this file system consists only of the files in the cartridge.</p>
</section>
<section id="pairing-phase">
<h3>Pairing phase<a class="headerlink" href="#pairing-phase" title="Link to this heading">#</a></h3>
<p>Once the frame exists, it’s loaded in the page and the pairing process
starts. This is a straightforward handshake:</p>
<ul class="simple">
<li><p>The kernel tells the application it’s ready to pair;</p></li>
<li><p>The application sends a pairing request to the kernel using its shared
secret, and provides a messaging channel for the kernel to reply;</p></li>
<li><p>The kernel validates the source and the secret. Then it creates a new
secure channel between itself and the application and sends it over
the channel the application shared previously.</p></li>
</ul>
<p>Once the pairing process is concluded, communication happens exclusively
through the message channel the kernel has created.</p>
</section>
<section id="service-initialisation">
<h3>Service initialisation<a class="headerlink" href="#service-initialisation" title="Link to this heading">#</a></h3>
<p>Once the kernel and the process are properly paired, we can start up and
link the process to the additional trusted-space services. This is where
we spin up the rendering process, the input-forwarding process, and the
IPC-handling process.</p>
<p>The IPC-handling process itself takes care of forwarding messages sent
by the application process to the relevant services and APIs, and then
takes care of replying to the application process with the result of
that operation. Further authorisation happens on the services/APIs
themselves.</p>
</section>
<section id="process-lifetime">
<h3>Process lifetime<a class="headerlink" href="#process-lifetime" title="Link to this heading">#</a></h3>
<p>During the process lifetime, it sends heartbeats and metrics to the
kernel in addition to the regular messages it sends for requesting
API permissions. This is necessary because the kernel is also not
allowed to read the state of the application processes directly;
it then treats it in a similar fashion to a remote node in a
distributed system.</p>
<p>Eventually processes go through changes of state (e.g.: pausing/unpausing),
and die. The kernel uses explicit transition messages to keep track of
what’s happening with the process, and may use heuristics based on heartbeats
and metrics when processes go rogue or become uncommunicable to take further
actions to ensure system stability and responsiveness.</p>
</section>
</section>
<section id="formal-semantics">
<h2>Formal semantics<a class="headerlink" href="#formal-semantics" title="Link to this heading">#</a></h2>
<p>Processes can be thought of as objects that communicate between each other
and have access to different sorts of resources. This gives rise to the
following model:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kr">type</span><span class="w"> </span><span class="kt">Meta</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">{</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">capabilities</span><span class="p">,</span><span class="w"> </span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="n">runtime</span><span class="p">}</span>
<span class="kr">type</span><span class="w"> </span><span class="kt">Manager</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">{[</span><span class="n">id</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Process</span><span class="o">...</span><span class="p">]}</span>
<span class="kr">type</span><span class="w"> </span><span class="kt">Frame</span><span class="o">-</span><span class="n">buffer</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">[</span><span class="n">msg</span><span class="o">...</span><span class="p">]</span>

<span class="kr">type</span><span class="w"> </span><span class="kt">Process</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="kt">Spawned</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span><span class="w"> </span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">secret</span><span class="p">,</span><span class="w"> </span><span class="n">public</span><span class="o">-</span><span class="n">channel</span><span class="p">)</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="kt">Pairing</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span><span class="w"> </span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">secret</span><span class="p">,</span><span class="w"> </span><span class="n">public</span><span class="o">-</span><span class="n">channel</span><span class="p">)</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="kt">Paired</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span><span class="w"> </span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">exclusive</span><span class="o">-</span><span class="n">channel</span><span class="p">)</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="kt">Dead</span>

<span class="kr">type</span><span class="w"> </span><span class="kt">Frame</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="kt">Spawned</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span><span class="w"> </span><span class="n">public</span><span class="o">-</span><span class="n">channel</span><span class="p">)</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="kt">Pairing</span><span class="p">(</span><span class="n">frame</span><span class="o">-</span><span class="n">channel</span><span class="p">)</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="kt">Paired</span><span class="p">(</span><span class="n">exclusive</span><span class="o">-</span><span class="n">channel</span><span class="p">)</span>

<span class="kt">Manager</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="ow">::</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">spawn</span><span class="p">(</span><span class="kt">Meta</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Spawned</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">pair</span><span class="p">(</span><span class="kt">Spawned</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Paired</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">kill</span><span class="p">(</span><span class="kt">Process</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">void</span>

<span class="kt">Process</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">::</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">send</span><span class="p">({</span><span class="kr">type</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">})</span>

<span class="kt">Frame</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="ow">::</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">send</span><span class="p">({</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="kr">type</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">})</span>
</pre></div>
</div>
<p>If we look at things from the perspective of the process manager. We may
spawn a process, which then allows us to pair the process, and eventually
we might choose to kill the process. Note that communication moves to
different channels over the course of this process.</p>
<section id="manager-semantics">
<h3>Manager semantics<a class="headerlink" href="#manager-semantics" title="Link to this heading">#</a></h3>
<section id="m-spawn-meta">
<h4><code class="docutils literal notranslate"><span class="pre">m.spawn(Meta)</span></code><a class="headerlink" href="#m-spawn-meta" title="Link to this heading">#</a></h4>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">m</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="n">i1</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">iN</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">pN</span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="o">.</span><span class="n">spawn</span><span class="p">({</span><span class="n">iA</span><span class="p">,</span><span class="w"> </span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="n">runtime</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">})</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="kt">Secret</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">unique</span><span class="o">-</span><span class="n">secret</span><span class="nb">()</span><span class="p">;</span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="kt">Code</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">runtime</span><span class="o">-</span><span class="n">code</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="n">runtime</span><span class="p">,</span><span class="w"> </span><span class="kt">Secret</span><span class="p">);</span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="kt">Frame</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">sandboxed</span><span class="o">-</span><span class="n">frame</span><span class="p">(</span><span class="kt">Code</span><span class="p">);</span>
<span class="w">  </span><span class="n">m</span><span class="w"> </span><span class="p">{[</span><span class="n">i1</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">iN</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">pN</span><span class="p">,</span><span class="w"> </span><span class="n">iA</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Spawned</span><span class="p">({</span><span class="n">iA</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">},</span><span class="w"> </span><span class="kt">Frame</span><span class="p">,</span><span class="w"> </span><span class="n">public</span><span class="o">-</span><span class="n">channel</span><span class="p">)]}</span>
</pre></div>
</div>
<p>That is, we can spawn a process from any runtime configuration given that
the id it’s been assigned does not conflict with one we’re running already.
This restriction is Kate-specific, and only here because we do not offer
tools to concurrently operate on a Process’ backing storage and resources,
so we can only run one copy of the application at any given time.</p>
<p>We then set up the runtime code that will be run in the sandboxed frame.
This includes a uniquely generated secret, whose only purpose is to
make it more likely that it is the Kate API that is establishing the
connection; note that in case the pairing is hijacked and other application
code establishes the connection that has no bearing on the security guarantees
we provide, as we treat all code in the frame with the same untrusted level.
But this prevents accidental pairings that would cause the API to not work
in the process, as it doesn’t have a channel to the kernel.</p>
<p>Finally we produce a spawned frame using the public channel, which is shared
by all processes in the system.</p>
</section>
<section id="m-pair-spawned">
<h4><code class="docutils literal notranslate"><span class="pre">m.pair(Spawned)</span></code><a class="headerlink" href="#m-pair-spawned" title="Link to this heading">#</a></h4>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">m</span><span class="w"> </span><span class="p">{[</span><span class="n">i</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">]}</span><span class="o">.</span><span class="n">pair</span><span class="p">(</span><span class="kt">Spawned</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">on</span><span class="w"> </span><span class="n">process</span><span class="o">.</span><span class="kt">Spawned</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span><span class="w"> </span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">secret</span><span class="p">,</span><span class="w"> </span><span class="n">public</span><span class="o">-</span><span class="n">channel</span><span class="p">)</span><span class="kt">:</span>
<span class="w">    </span><span class="n">public</span><span class="o">-</span><span class="n">channel</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kt">PAIRING_READY</span><span class="p">;</span>
<span class="w">    </span><span class="n">state</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="kt">Pairing</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span><span class="w"> </span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">secret</span><span class="p">,</span><span class="w"> </span><span class="n">public</span><span class="o">-</span><span class="n">channel</span><span class="p">);</span>

<span class="w">  </span><span class="n">on</span><span class="w"> </span><span class="n">frame</span><span class="o">.</span><span class="kt">Spawned</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span><span class="w"> </span><span class="n">public</span><span class="o">-</span><span class="n">channel</span><span class="p">)</span><span class="kt">:</span>
<span class="w">    </span><span class="n">wait</span><span class="w"> </span><span class="n">public</span><span class="o">-</span><span class="n">channel</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="n">sent</span><span class="w"> </span><span class="kt">PAIRING_READY:</span>
<span class="w">      </span><span class="kr">let</span><span class="w"> </span><span class="p">{</span><span class="kt">KernelPort</span><span class="p">,</span><span class="w"> </span><span class="kt">FramePort</span><span class="p">}</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">message</span><span class="o">-</span><span class="n">channel</span><span class="nb">()</span><span class="p">;</span>
<span class="w">      </span><span class="n">public</span><span class="o">-</span><span class="n">channel</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kt">PAIR</span><span class="w"> </span><span class="p">{</span><span class="kt">KernelPort</span><span class="p">};</span>
<span class="w">      </span><span class="n">state</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="kt">Pairing</span><span class="p">(</span><span class="kt">FramePort</span><span class="p">);</span>

<span class="w">  </span><span class="n">on</span><span class="w"> </span><span class="n">process</span><span class="o">.</span><span class="kt">Pairing</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span><span class="w"> </span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">secret</span><span class="p">,</span><span class="w"> </span><span class="n">public</span><span class="o">-</span><span class="n">channel</span><span class="p">)</span><span class="kt">:</span>
<span class="w">    </span><span class="n">wait</span><span class="w"> </span><span class="n">public</span><span class="o">-</span><span class="n">channel</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="n">sent</span><span class="w"> </span><span class="kt">PAIR</span><span class="w"> </span><span class="p">{</span><span class="n">frame</span><span class="o">-</span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">secret</span><span class="p">}</span><span class="kt">:</span>
<span class="w">      </span><span class="kr">let</span><span class="w"> </span><span class="p">{</span><span class="kt">KernelPort</span><span class="p">,</span><span class="w"> </span><span class="kt">FramePort</span><span class="p">}</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">message</span><span class="o">-</span><span class="n">channel</span><span class="nb">()</span><span class="p">;</span>
<span class="w">      </span><span class="n">frame</span><span class="o">-</span><span class="n">channel</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kt">PAIR</span><span class="w"> </span><span class="p">{</span><span class="kt">FramePort</span><span class="p">};</span>
<span class="w">      </span><span class="n">state</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="kt">Paired</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span><span class="w"> </span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="kt">KernelPort</span><span class="p">);</span>

<span class="w">  </span><span class="n">on</span><span class="w"> </span><span class="n">frame</span><span class="o">.</span><span class="kt">Pairing</span><span class="p">(</span><span class="n">frame</span><span class="o">-</span><span class="n">port</span><span class="p">)</span><span class="kt">:</span>
<span class="w">    </span><span class="n">wait</span><span class="w"> </span><span class="n">frame</span><span class="o">-</span><span class="n">channel</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="n">sent</span><span class="w"> </span><span class="kt">PAIR</span><span class="w"> </span><span class="p">{</span><span class="n">exclusive</span><span class="o">-</span><span class="n">channel</span><span class="p">}</span><span class="kt">:</span>
<span class="w">      </span><span class="n">for</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="kt">Frame</span><span class="o">-</span><span class="n">buffer</span><span class="kt">:</span><span class="w"> </span><span class="n">frame</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="w">      </span><span class="n">state</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="kt">Paired</span><span class="p">(</span><span class="n">exclusive</span><span class="o">-</span><span class="n">channel</span><span class="p">);</span>
</pre></div>
</div>
<p>That is, the we start with a public channel, which is usable by all processes
in the system, and send the frame a <cite>pairing-ready</cite> message. The frame then
creates a new channel and asks the kernel to pair. The process creates
a new exclusive and authenticated channel between the two parties and
sends the channel over to the frame. At this point both the process and
the frame are considered paired, and communication can proceed in the
exclusive channel.</p>
<p>Note that since cartridge code _may_ start running before the frame is fully
paired, it can end up buffering messages. These buffered messages are all
sent in a burst once the frame is paired.</p>
</section>
<section id="m-kill-process">
<h4><code class="docutils literal notranslate"><span class="pre">m.kill(Process)</span></code><a class="headerlink" href="#m-kill-process" title="Link to this heading">#</a></h4>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">m</span><span class="w"> </span><span class="p">{[</span><span class="n">i</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">]}</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">unload</span><span class="o">-</span><span class="n">application</span><span class="p">(</span><span class="n">p1</span><span class="p">);</span>
<span class="w">  </span><span class="n">m</span><span class="w"> </span><span class="p">{[</span><span class="o">...</span><span class="p">]}</span>
</pre></div>
</div>
<p>Killing a process is a one-sided, ungracefull operation. The kernel
unloads the application code from memory and removes it from the
process table.</p>
</section>
</section>
<section id="message-sending-semantics">
<h3>Message sending semantics<a class="headerlink" href="#message-sending-semantics" title="Link to this heading">#</a></h3>
<section id="p-send-msg">
<h4><code class="docutils literal notranslate"><span class="pre">p.send(msg)</span></code><a class="headerlink" href="#p-send-msg" title="Link to this heading">#</a></h4>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kt">Process</span><span class="o">.</span><span class="kt">Paired</span><span class="p">(</span><span class="n">exclusive</span><span class="o">-</span><span class="n">channel</span><span class="p">)</span><span class="o">.</span><span class="n">send</span><span class="p">({</span><span class="kr">type</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">})</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">exclusive</span><span class="o">-</span><span class="n">channel</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="p">{</span><span class="kr">type</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">}</span>
</pre></div>
</div>
<p>That is, sending a message from a process to the frame succeeds whenever
they’re fully paired, but the process does not wait for any response to it.
All process -&gt; frame requests are fire-and-forget.</p>
</section>
<section id="f-send-msg">
<h4><code class="docutils literal notranslate"><span class="pre">f.send(msg)</span></code><a class="headerlink" href="#f-send-msg" title="Link to this heading">#</a></h4>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kt">Frame</span><span class="o">.</span><span class="kt">Paired</span><span class="p">(</span><span class="n">exclusive</span><span class="o">-</span><span class="n">cahnenl</span><span class="p">)</span><span class="o">.</span><span class="n">send</span><span class="p">({</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="kr">type</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">})</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">exclusive</span><span class="o">-</span><span class="n">channel</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="p">{</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="kr">type</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">}</span>

<span class="w">  </span><span class="n">wait</span><span class="w"> </span><span class="n">exclusive</span><span class="o">-</span><span class="n">channel</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="n">proces</span><span class="w"> </span><span class="n">sent</span><span class="w"> </span><span class="kt">REPLY</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="p">}</span><span class="kt">:</span>
<span class="w">    </span><span class="n">return</span><span class="w"> </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">}</span>

<span class="kt">Frame</span><span class="o">.</span><span class="n">send</span><span class="p">({</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="kr">type</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">})</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="kt">Frame</span><span class="o">-</span><span class="n">buffer</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">[{</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="kr">type</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">},</span><span class="w"> </span><span class="o">...</span><span class="kt">Frame</span><span class="o">-</span><span class="n">buffer</span><span class="p">]</span>
</pre></div>
</div>
<p>Sending messages from the frame to the process is likewise straightforward
once both are paired, with the added capability that these messages include
an unique identifier that the process uses to send a reply back (as they
usually relate to API calls that must return a resource).</p>
<p>Additionally, since cartridge code may start running before the frame is
fully paired, any message sent in that time is buffered and sent as soon
as a successful pairing happens.</p>
</section>
</section>
</section>
<section id="how-is-this-feature-dangerous">
<h2>How is this feature dangerous?<a class="headerlink" href="#how-is-this-feature-dangerous" title="Link to this heading">#</a></h2>
<p>Almost every other security guarantee in Kate depends on processes being
correctly isolated. Here we consider risks from users’, cartridges’, and
Kate’s perspectives.</p>
<dl>
<dt><strong>Frames accessing the Kernel directly</strong>:</dt><dd><p>Because frames are embedded in the same document as Kate, it’s possible
that they may access the Kernel directly, bypassing the security features
Kate relies on.</p>
<p>Kate mitigates this by relying on the Browser to isolate the frame, loading
it in an opaque origin (through the <code class="docutils literal notranslate"><span class="pre">sandbox</span></code> feature of iframes).</p>
</dd>
<dt><strong>Frames accessing powerful features directly</strong></dt><dd><p>Because browsers allow access to powerful features, such as camera and
microphone, by default, there’s a risk that frames may access these powerful
features directly, violating Kate’s guarantees of privacy and security.</p>
<p>Kate mitigates this by setting restrictive security policies in the Frame,
using a combination of <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe#attributes">Sandbox policies</a>,
<a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Permissions_Policy">Permissions policies</a>,
and <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Glossary/CSP">Content Security policies</a>.
For features that are not covered by the policies, e.g.: user agent strings,
the Kernel uses source code translation and dynamic patching to remove access
to it.</p>
</dd>
<dt><strong>Denial of service attacks</strong>:</dt><dd><p>Because the Kernel is not involved in managing computational resources
such as memory and CPU, there’s a risk that processes may unfairly use them
in a way that makes Kate unusable, or results in Kate beung killed by the OS.</p>
<p>Kate cannot mitigate this without the browser providing a way of setting
computational limits on sub-processes, so we have to live with the risk.
The impact of this is limited due to Kate’s design of running only a single
process in foreground.</p>
</dd>
<dt><strong>Leaking sensitive data from privileged processes</strong>:</dt><dd><p>Because Kate runs the Kernel and the untrusted application processes in the
same web-page, there’s a risk that untrusted processes may abuse side-channel
attacks to read privileged data.</p>
<p>Kate does not mitigate this directly, but relies on Browser’s hardening
against Spectre and similar side-channel/timing attacks. This means that
for our security properties to hold, browsers need to handle Kate’s kernel
process and the applications’ processes in separate processes and sandboxes.
At the time of writing, Chrome and Firefox still consolidate frames created
from Blob/Data URLs.</p>
<p>The impact of this is, however, smaller due to the fact that application
processes have no network or other out-of-process I/O access by default,
so exfiltration of this data is often not possible, at least without
requesting powerful capabilities and having explicit user consent.</p>
</dd>
<dt><strong>Blocked cartridges due to security restrictions</strong>:</dt><dd><p>Because the kernel assigns fairly restrictive policies to the frame that
host the cartridge’s code, it’s possible that a cartridge that would work
fine in a web context does not work in Kate.</p>
<p>We mitigate parts of this by offering Bridges for developers to emulate
web features using the more restrictive model Kate has, however we accept
the impact (“the cartridge doesn’t run”) in favour of improved security for
players, and shift the burden of finding a safe/Kate-friendly way forward to
application developers instead.</p>
</dd>
<dt><strong>Cartridge code pairing instead of Kate API code</strong>:</dt><dd><p>Because the cartridge code starts running before the pairing process has
finished, it’s technically possible (but improbable) that the cartridge
code wins the race to provide a pairing channel to the kernel code. In that
case the kernel would be communicating directly with the cartridge code
instead of the injected Kate API code.</p>
<p>We mitigate this by requiring a secret shared between the kernel and the
Kate API code when pairing, however, since the kernel treats the whole
cartridge process as untrusted, this impacts only the cartridge developers,
in the sense that the Kate API and bridges would not do any of the
dynamic emulation work, and developers would be responsible for re-implementing
that code using the IPC port directly.</p>
</dd>
<dt><strong>Authorisation confusion</strong></dt><dd><p>Because the kernel handles all requests for resources and these come from
untrusted cartridge processes, there’s a risk that the kernel might honour
a request the cartridge should not have permission for.</p>
<p>We address this by using a separate authenticated channel for each process,
and storing the capabilities in the process’ object on the kernel side. This
way the kernel always knows what set of capabilities to use when handling
a message coming from an arbitrary port. Actual capability authorisation
is done by the Capability Supervisor, as described in <a class="reference internal" href="K0001-capabilities.html"><span class="doc">#K0001 — Capabilities</span></a>.</p>
</dd>
<dt><strong>Buffered messages due to long pairing</strong>:</dt><dd><p>Because the cartridge may start running code that sends messages to the
kernel process before pairing is complete, the Kate API code will buffer
those messages and send them later, this might cause increased memory usage.</p>
<p>We mitigate this by placing a heuristic limit on the buffer size, such that
if we stall or never complete the pairing process, the buffered messages
have less chance of taking down the whole device. Further computational
restrictions are placed by the browser itself, who may kill the tab if
the allocated memory is too high.</p>
</dd>
<dt><strong>Pairing never completes</strong>:</dt><dd><p>Due to the distributed nature of Kate’s processes, where neither side
actually knows the internals of the other and thus is unable to know
if progress is being made, it’s possible that pairing stalls and never
completes, leaving the player with an eternal “loading” screen.</p>
<p>While players can kill these processes on their own, the kernel process
also places an upper-bound limit on the time pairing can take, as under
usual circumstances it should happen near-immediate.</p>
</dd>
</dl>
</section>
<section id="references-and-additional-material">
<h2>References and additional material<a class="headerlink" href="#references-and-additional-material" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://www.w3.org/TR/post-spectre-webdev/">Post-Spectre Web Development</a></p></li>
<li><p><a class="reference external" href="https://chromium.googlesource.com/chromium/src/+/main/docs/process_model_and_site_isolation.md">Chromium’s process model and site isolation</a></p></li>
<li><p><a class="reference external" href="https://wiki.mozilla.org/Project_Fission">Firefox’s Project Fission</a></p></li>
</ul>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="K0005-partitioned-file-storage.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">#K0005 — Partitioned File Storage</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="K0003-resource-band.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">#K0003 — Resource band</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023-2024, Niini
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">#K0004 — Processes</a><ul>
<li><a class="reference internal" href="#timeline">Timeline</a></li>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#technical-summary">Technical summary</a><ul>
<li><a class="reference internal" href="#spawning-phase">Spawning phase</a></li>
<li><a class="reference internal" href="#pairing-phase">Pairing phase</a></li>
<li><a class="reference internal" href="#service-initialisation">Service initialisation</a></li>
<li><a class="reference internal" href="#process-lifetime">Process lifetime</a></li>
</ul>
</li>
<li><a class="reference internal" href="#formal-semantics">Formal semantics</a><ul>
<li><a class="reference internal" href="#manager-semantics">Manager semantics</a><ul>
<li><a class="reference internal" href="#m-spawn-meta"><code class="docutils literal notranslate"><span class="pre">m.spawn(Meta)</span></code></a></li>
<li><a class="reference internal" href="#m-pair-spawned"><code class="docutils literal notranslate"><span class="pre">m.pair(Spawned)</span></code></a></li>
<li><a class="reference internal" href="#m-kill-process"><code class="docutils literal notranslate"><span class="pre">m.kill(Process)</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#message-sending-semantics">Message sending semantics</a><ul>
<li><a class="reference internal" href="#p-send-msg"><code class="docutils literal notranslate"><span class="pre">p.send(msg)</span></code></a></li>
<li><a class="reference internal" href="#f-send-msg"><code class="docutils literal notranslate"><span class="pre">f.send(msg)</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-is-this-feature-dangerous">How is this feature dangerous?</a></li>
<li><a class="reference internal" href="#references-and-additional-material">References and additional material</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=594d7d3c"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=32e29ea5"></script>
    </body>
</html>