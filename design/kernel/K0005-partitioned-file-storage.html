<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><link rel="next" title="#K0006 — Cartridge signatures" href="K0006-cartridge-signatures.html" /><link rel="prev" title="#K0004 — Processes" href="K0004-processes.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2023.09.10 -->
        <title>#K0005 — Partitioned File Storage - Kate 0.25 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=82a976d7" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=d1035e3f" />
    
    


<style>
  body {
    --color-code-background: #ffffff;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<div class="announcement">
  <aside class="announcement-content">
     Both Kate and this documentation are a work in progress and may change at any time. 
  </aside>
</div>

<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">Kate 0.25 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">Kate 0.25 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">End-user books</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../user/manual/index.html">The Kate User Manual</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of The Kate User Manual</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../user/manual/intro/index.html">Getting started</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Getting started</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/intro/hardware.html">Tech specs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/intro/emulator.html">Emulator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/intro/install.html">Installing</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../user/manual/gaming/index.html">Playing games</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Playing games</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/gaming/cartridges.html">ROM Cartridges</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/gaming/captures.html">Screen recording</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/gaming/save-data.html">Save data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/gaming/play-habits.html">Play habits</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/gaming/storage.html">Stored data</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../user/manual/security/index.html">Security and privacy</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of Security and privacy</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/security/philosophy.html">Safety philosophy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/security/sandboxing.html">Sandboxing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/security/privacy.html">Privacy policy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/security/trust.html">Trust and consent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../user/manual/security/audit.html">Audit logs</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../user/importer/index.html">The Kate Importer Manual</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of The Kate Importer Manual</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../user/importer/renpy.html">Ren’Py</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user/importer/bitsy.html">Bitsy</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../user/diy/index.html">Build Your Own Console!</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Build Your Own Console!</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../user/diy/overview/index.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user/diy/hardware/index.html">The hardware</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Game developer books</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../dev/manual/index.html">Making games for Kate!</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of Making games for Kate!</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../dev/manual/intro/index.html">Getting started</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of Getting started</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/intro/why.html">Why make games for Kate?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/intro/setup.html">What will you need?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/intro/hello-world.html">Hello, World</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../dev/manual/model/index.html">Programming model</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of Programming model</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/model/overview.html">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/model/cartridges.html">Cartridges</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/model/sandboxing.html">Sandboxing and APIs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/model/capabilities.html">Capabilities</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../dev/manual/api/index.html">Kate API</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of Kate API</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/api/events.html"><code class="docutils literal notranslate"><span class="pre">events</span></code> — Event handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/api/cart-fs.html"><code class="docutils literal notranslate"><span class="pre">cart_fs</span></code> — Reading files</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/api/input.html"><code class="docutils literal notranslate"><span class="pre">*_input</span></code> — Reacting to player input</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/api/timer.html"><code class="docutils literal notranslate"><span class="pre">timer</span></code> — Scheduling updates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/api/capture.html"><code class="docutils literal notranslate"><span class="pre">capture</span></code> — Screenshots and video recording</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/api/store.html"><code class="docutils literal notranslate"><span class="pre">store</span></code> — Saving state</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/api/browser.html"><code class="docutils literal notranslate"><span class="pre">browser</span></code> — Navigating to URLs</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../dev/manual/web/index.html">Web game support</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle navigation of Web game support</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/web/basics.html">Basics of porting</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../dev/manual/web/bridges/index.html">Bridges</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle navigation of Bridges</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/network-proxy.html">Network proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/input-proxy.html">Button input proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/pointer-input-proxy.html">Pointer input proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/local-storage-proxy.html">Local storage proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/indexeddb-proxy.html">IndexedDB proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/external-url-handler.html">External URL handler</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/preserve-webgl-render.html">Preserve WebGL Render</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/capture-canvas.html">Capture canvas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev/manual/web/bridges/renpy-tweaks.html">Ren’Py tweaks</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../dev/manual/packing/index.html">Packaging cartridges</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle navigation of Packaging cartridges</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/packing/getting-started.html">Getting started</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/manual/packing/configuration.html">Configuration files</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../dev/port/index.html">Kate Porting Recipes</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><div class="visually-hidden">Toggle navigation of Kate Porting Recipes</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../dev/port/bitsy.html">Bitsy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/port/renpy.html">Ren’Py</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/port/godot.html">Godot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/port/rpg-maker.html">RPG Maker MV</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/port/gamemaker.html">GameMaker</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Design and implementation</span></p>
<ul class="current">
<li class="toctree-l1 current has-children"><a class="reference internal" href="../index.html">Kate’s Design Documents</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><div class="visually-hidden">Toggle navigation of Kate’s Design Documents</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../formats/F0001-ljt.html">#F0001 — The LJT language</a></li>
<li class="toctree-l2"><a class="reference internal" href="../formats/F0002-kart.html">#F0002 — KART cartridges</a></li>
<li class="toctree-l2"><a class="reference internal" href="K0001-capabilities.html">#K0001 — Capabilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="K0002-live-audit.html">#K0002 — Live auditing</a></li>
<li class="toctree-l2"><a class="reference internal" href="K0003-resource-band.html">#K0003 — Resource band</a></li>
<li class="toctree-l2"><a class="reference internal" href="K0004-processes.html">#K0004 — Processes</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">#K0005 — Partitioned File Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="K0006-cartridge-signatures.html">#K0006 — Cartridge signatures</a></li>
<li class="toctree-l2"><a class="reference internal" href="K0007-key-store.html">#K0007 — Secure key store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/A0001-object-storage.html">#A0001 — Object Store API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/A0002-external-url.html">#A0002 — External URL navigation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/A0003-device-file-access.html">#A0003 — Device file access</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Changes, Terms, and Credits</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../etc/releases/index.html">Release notes</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><div class="visually-hidden">Toggle navigation of Release notes</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../etc/releases/0.25.html">Kate v0.25  (Spring 2024)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../etc/releases/0.23.10.html">Kate v0.23.10  (October 2023)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../etc/releases/0.23.8.html">Kate v0.23.8  (August 2023)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../etc/releases/0.23.6.html">Kate v0.23.6  (June 2023)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../etc/releases/0.23.5.html">Kate v0.23.5  (May 2023)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../etc/releases/0.23.4.html">Kate v0.23.4  (April 2023)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../etc/licence.html">Terms of use</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Indices and Tables</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../py-modindex.html">Module Index</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="edit-this-page">
  <a class="muted-link" href="https://github.com/qteatime/kate/edit/main/docs/source/design/kernel/K0005-partitioned-file-storage.rst" title="Edit this page">
    <svg aria-hidden="true" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
      <line x1="13.5" y1="6.5" x2="17.5" y2="10.5" />
    </svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="k0005-partitioned-file-storage">
<h1>#K0005 — Partitioned File Storage<a class="headerlink" href="#k0005-partitioned-file-storage" title="Link to this heading">#</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd"><p>Niini</p>
</dd>
<dt class="field-even">Started<span class="colon">:</span></dt>
<dd class="field-even"><p>2023-12-08</p>
</dd>
<dt class="field-odd">Last updated<span class="colon">:</span></dt>
<dd class="field-odd"><p>2023-12-25</p>
</dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><p>Design in progress</p>
</dd>
</dl>
<section id="timeline">
<h2>Timeline<a class="headerlink" href="#timeline" title="Link to this heading">#</a></h2>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>First draft</p></th>
<th class="head"><p>Proof of Concept</p></th>
<th class="head"><p>Stable implementation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>2023-12-12</p></td>
<td><p>—</p></td>
<td><p>—</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h2>
<p>Kate has two distinct needs for storing arbitrary binary data under well-known
names:</p>
<ul class="simple">
<li><p><strong>Reliably persistent data</strong>: E.g.: cartridge data needs to be available for
as long as the player is able to launch that cartridge, thus needs a reliable
and persistent backing storage.</p></li>
<li><p><strong>Ephemeral work area for large data</strong>: E.g.: the importer needs to access
files from a ZIP archive to process them into a Kate cartridge.</p></li>
</ul>
<p>A backing file store must thus address these two use cases while also making
sure that we guarantee all other security and privacy guarantees Kate has.
That is, data must be partitioned to the processes that own them, with no
way of distinct processes to forge access to these pieces of data.</p>
<p>To that end we introduce a new file backing storage on top of the
Origin Private File System API that uses content-addressed binaries
in distinct buckets, which are also divided into distinct “lifecycle”
partitions.</p>
<p>Keep in mind that we need:</p>
<ul class="simple">
<li><p><strong>Partitioned lifecycle</strong>: All buckets are subject to be garbage collected
once there are no more references to it, but the frequency of garbage
collection might vary.</p></li>
<li><p><strong>Strong capabilities</strong>: Buckets can only be accessed by the owning process,
and they must be handed a capability for it — there must be no way of
forging capabilities for arbitrary buckets (i.e.: no root directory
accessible from the process).</p></li>
<li><p><strong>Memory friendly</strong>: Since we will be using the storage for large binaries,
the API must allow interacting with this storage using bounded memory.</p></li>
</ul>
</section>
<section id="surface-interface">
<h2>Surface interface<a class="headerlink" href="#surface-interface" title="Link to this heading">#</a></h2>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="kd">interface</span><span class="w"> </span><span class="nx">FileStore</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">get_partition</span><span class="p">(</span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Partition</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">from_key</span><span class="p">(</span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="kt">PersistentKey</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="p">{</span><span class="nx">partition</span><span class="o">:</span><span class="w"> </span><span class="kt">Partition</span><span class="p">,</span><span class="w"> </span><span class="nx">bucket</span><span class="o">:</span><span class="w"> </span><span class="kt">Bucket</span><span class="p">}</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">gc</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">Partition</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">create</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Bucket</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">get</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">BucketId</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Bucket</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">release</span><span class="p">(</span><span class="nx">bucket</span><span class="o">:</span><span class="w"> </span><span class="kt">Bucket</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="p">;</span>
<span class="w">  </span><span class="nx">release_persistent</span><span class="p">(</span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="kt">PersistentKey</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="p">;</span>
<span class="w">  </span><span class="nx">persist</span><span class="p">(</span><span class="nx">bucket</span><span class="o">:</span><span class="w"> </span><span class="kt">Bucket</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">PersistentKey</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">Bucket</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">put</span><span class="p">(</span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">ArrayBuffer</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">File</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">file</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">FileId</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">File</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">File</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">FileId</span><span class="p">;</span>
<span class="w">  </span><span class="nx">read</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Uint8Array</span><span class="p">;</span>
<span class="w">  </span><span class="ow">delete</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note the lack of explicit deletion for buckets: they’re garbage collected
automatically once there are no more references to it!</p>
</section>
<section id="ephemeral-and-persistent-buckets">
<h2>Ephemeral and persistent buckets<a class="headerlink" href="#ephemeral-and-persistent-buckets" title="Link to this heading">#</a></h2>
<p>All buckets start their life as ephemeral ones — they’re kept alive for as
long as there are in-memory references to them, and they’re garbage collected
as soon as no in-memory references to them remain. Like with regular
programming language garbage collection, bucket garbage collection is not
<em>observable</em> by the code, since as far as code is concerned there’s no way
of getting to the bucket anymore. Kate also does not expose storage space
metrics to regular code, which must assume the user has “an unlimited supply
of storage space”.</p>
<p>Buckets can however be <em>promoted</em> to a persistent bucket. Persistent buckets
are “ephemeral” buckets that have long-lived in-storage references. For example,
buckets backing cartridge data start as ephemeral ones during installation,
and progress to persistent just before the cartridge is reified in the
database. From that point on, the bucket is only garbage collected if
no in-memory <strong>and</strong> in-storage references to it remain.</p>
<p>For tracking in-storage references Kate does a best-effort of managing the
reference counter manually from the reference holders — e.g.: during
cartridge installation the cartridge manager service will manually release
the persistent reference it holds in storage. But the garbage collection
process will also ocasionally scan its persistent buckets and check if
the persistent references it knows about are still pointing back to the
bucket. This means that even if the reference is not manually released,
e.g.: if an installation process fails between persisting the bucket and
persisting the cartridge in the database, the next time the garbage collector
runs it’ll notice that there’s no database recording pointing back, and it’ll
adjust the reference counter accordingly, most likely resulting in the bucket
being collected.</p>
<section id="persistent-references">
<h3>Persistent references<a class="headerlink" href="#persistent-references" title="Link to this heading">#</a></h3>
<p>A <code class="docutils literal notranslate"><span class="pre">PersistentKey</span></code> or persistent reference is a reference stored on both the
bucket side and the persistent storage side. This includes details on the
process or service that holds the persistent reference, and allows the garbage
collector to verify if that reference is still valid, thus getting around
issues with unreliable reference counting, and also helping in detecting
storage leaks.</p>
<p>It’s defined as a sum type of with a unique tag for each service, plus the
details the service needs to verify if the reference is still valid. For
example, cartridge data buckets are persisted with the cartridge identifier
and version, which means that the garbage collector can point to the cartridge
manager where it should look for the reference. It also includes the
partition id and bucket id, which allows the garbage collector to know if the
holder of that reference is pointing back to the exact bucket that the
garbage collector is looking at.</p>
<p>The bucket back-references are important because not all storage processes
are immutable. For example, it <em>is</em> possible to overwrite a cartridge with
another of the same id/version in some circumstances, but because Kate cannot
guarantee that they’ll have the same content it has to use a different bucket
for the new installation. This can result in a case where the bucket X points
to cartridge <a class="reference external" href="mailto:A&#37;&#52;&#48;v1">A<span>&#64;</span>v1</a>, but cartridge <a class="reference external" href="mailto:A&#37;&#52;&#48;v1">A<span>&#64;</span>v1</a> points back to a different bucket Y,
allowing the bucket X to be safely garbage collected.</p>
</section>
<section id="ephemeral-buckets-from-cartridges">
<h3>Ephemeral buckets from cartridges<a class="headerlink" href="#ephemeral-buckets-from-cartridges" title="Link to this heading">#</a></h3>
<p>Cartridges are also able to spawn new ephemeral buckets into existence for
their own storage needs. For example, a cartridge that needs to work with
large archive files might choose to unpack those files to a bucket to keep
memory usage bounded at reasonable levels, rather than increasing linearly
with the archive size.</p>
<p>With this usage of ephemeral buckets our in-memory approach does not hold
as well, since the Kernel and the cartridge processes run in different,
isolated memory spaces. This is solved by putting a service between the
file storage and the cartridge that manages buckets for that cartridge
process specifically, and keeps them alive for as long as the process
needs it to be alive — which in worst cases is until the process dies.</p>
<p>Further, we need to have bounds on the storage usage to prevent malicious
or misbehaving cartridges from unfairly degrading the underlying storage.
There’s no real one-size-fits-all here, as cartridges that a user run
may have wildly different requirements, so this limit must be configurable
by the user, though it should never exceed 60% of the Kate storage quota.</p>
</section>
</section>
<section id="formal-semantics">
<h2>Formal semantics<a class="headerlink" href="#formal-semantics" title="Link to this heading">#</a></h2>
<p>You can think of the file storage as a collection of reference-counted buckets
holding arbitrary objects. Buckets cannot hold other buckets. Partitions are
only used to give the GC a generational-ish behaviour where long-lived
partitions don’t need to be scanned as often. It also helps with debugging.
For that reason it’s not a part of the formal semantics, since it doesn’t
affect the semantics of buckets and files.</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kr">type</span><span class="w"> </span><span class="kt">Ref</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">uint</span><span class="p">;</span>
<span class="kr">type</span><span class="w"> </span><span class="kt">Store</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">[{</span><span class="n">r1</span><span class="p">,</span><span class="w"> </span><span class="n">b1</span><span class="p">},</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">rN</span><span class="p">,</span><span class="w"> </span><span class="n">bN</span><span class="p">}]</span>
<span class="kr">type</span><span class="w"> </span><span class="kt">Bucket</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">{</span><span class="n">bid</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="n">unique</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">f1</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">fN</span><span class="p">]};</span>
<span class="kr">type</span><span class="w"> </span><span class="kt">File</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">{</span><span class="n">fid</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="n">unique</span><span class="p">,</span><span class="w"> </span><span class="kr">data</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="n">bytes</span><span class="p">};</span>

<span class="kt">Store</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">::</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">create</span><span class="o">-</span><span class="n">bucket</span><span class="nb">()</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="n">bid</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">}</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">drop</span><span class="p">(</span><span class="n">bid</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">s2</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">copy</span><span class="p">(</span><span class="n">bid</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">s2</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">gc</span><span class="nb">()</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">s2</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">put</span><span class="o">-</span><span class="n">file</span><span class="p">(</span><span class="n">bid</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="n">fid</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">}</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">read</span><span class="o">-</span><span class="n">file</span><span class="p">(</span><span class="n">bid</span><span class="p">,</span><span class="w"> </span><span class="n">fid</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">bytes</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">delete</span><span class="o">-</span><span class="n">file</span><span class="p">(</span><span class="n">bid</span><span class="p">,</span><span class="w"> </span><span class="n">fid</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">s2</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">has</span><span class="o">-</span><span class="n">file</span><span class="p">(</span><span class="n">bid</span><span class="p">,</span><span class="w"> </span><span class="n">fid</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">bool</span>
</pre></div>
</div>
<p>Reference-counted semantics are reflected here on the explicit <code class="docutils literal notranslate"><span class="pre">drop</span></code> and
<code class="docutils literal notranslate"><span class="pre">copy</span></code> operations, which increase and decrease the reference counter
respectively.</p>
<section id="bucket-life-cycle">
<h3>Bucket life-cycle<a class="headerlink" href="#bucket-life-cycle" title="Link to this heading">#</a></h3>
<section id="s-create-bucket">
<h4><code class="docutils literal notranslate"><span class="pre">s.create-bucket()</span></code><a class="headerlink" href="#s-create-bucket" title="Link to this heading">#</a></h4>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">s</span><span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="o">-</span><span class="n">bucket</span><span class="nb">()</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="kt">Id</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">allocate</span><span class="o">-</span><span class="n">storage</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">unique</span><span class="o">-</span><span class="n">id</span><span class="nb">()</span><span class="p">;</span>
<span class="w">  </span><span class="p">{</span><span class="kt">Id</span><span class="p">,</span><span class="w"> </span><span class="p">[{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="kt">Id</span><span class="p">,</span><span class="w"> </span><span class="kt">[]</span><span class="p">}},</span><span class="w"> </span><span class="o">...</span><span class="p">]}</span>
</pre></div>
</div>
<p>That is, when we create a bucket we just reserve a unique identifier in the
storage for it. There’s no possibility of giving buckets a recognisable name
because the file storage is not meant for regular browsing, but rather just
as a backing storage for different front-ends.</p>
<p>Note that buckets start their lifecycle with the reference counter set to 1,
since we <em>are</em> holding onto the reference and passing it to the caller.</p>
</section>
<section id="s-gc">
<h4><code class="docutils literal notranslate"><span class="pre">s.gc()</span></code><a class="headerlink" href="#s-gc" title="Link to this heading">#</a></h4>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kt">[]</span><span class="o">.</span><span class="n">gc</span><span class="nb">()</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">[]</span>

<span class="p">[{</span><span class="n">refs</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">files</span><span class="p">}},</span><span class="w"> </span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">gc</span><span class="nb">()</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="n">refs</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="mi">0</span><span class="kt">:</span>
<span class="w">    </span><span class="n">free</span><span class="o">-</span><span class="n">allocated</span><span class="o">-</span><span class="n">storage</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="w">    </span><span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">gc</span><span class="nb">()</span>
<span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="n">refs</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="kt">:</span><span class="w"> </span><span class="p">[{</span><span class="n">refs</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">files</span><span class="p">}},</span><span class="w"> </span><span class="o">...</span><span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">gc</span><span class="nb">()</span><span class="p">]</span>
</pre></div>
</div>
<p>That is, the GC process just goes through each bucket, checks their reference
counter, and frees all buckets whose reference counters reached 0. At the end
of this process the storage will only hold the list of buckets that are still
alive.</p>
<p>Note that there’s no defined semantics for negative reference counters, the
process would get stuck there, but a practical implementation <strong>must</strong> ensure
that negative references are not possible.</p>
</section>
<section id="b-drop">
<h4><code class="docutils literal notranslate"><span class="pre">b.drop()</span></code><a class="headerlink" href="#b-drop" title="Link to this heading">#</a></h4>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">s</span><span class="w"> </span><span class="p">[{</span><span class="n">refs</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="kr">data</span><span class="p">},</span><span class="w"> </span><span class="o">...</span><span class="p">}]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">refs</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">s</span><span class="w"> </span><span class="p">[{</span><span class="n">refs</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="kr">data</span><span class="p">}},</span><span class="w"> </span><span class="o">...</span><span class="p">];</span>
</pre></div>
</div>
<p>That is, <code class="docutils literal notranslate"><span class="pre">drop()</span></code> decreases the reference counter, but it is not defined
for cases where it’s called on a bucket whose reference counter is already
at zero.</p>
<p>A practical implementation <strong>must not</strong> let this happen: you cannot call a
function on an object no one holds a reference to.</p>
</section>
<section id="b-copy">
<h4><code class="docutils literal notranslate"><span class="pre">b.copy()</span></code><a class="headerlink" href="#b-copy" title="Link to this heading">#</a></h4>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">s</span><span class="w"> </span><span class="p">[{</span><span class="n">refs</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="kr">data</span><span class="p">},</span><span class="w"> </span><span class="o">...</span><span class="p">}]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">refs</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">s</span><span class="w"> </span><span class="p">[{</span><span class="n">refs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="kr">data</span><span class="p">}},</span><span class="w"> </span><span class="o">...</span><span class="p">];</span>
</pre></div>
</div>
<p>Once again, <code class="docutils literal notranslate"><span class="pre">copy()</span></code> increases the reference counter, but it is not defined
for cases where it’s called on a bucket whose reference counter is already at
zero.</p>
<p>A practical implementation <strong>must not</strong> let this happen: you cannot call a
funciton on an object no one holds a reference to.</p>
</section>
</section>
<section id="file-management">
<h3>File management<a class="headerlink" href="#file-management" title="Link to this heading">#</a></h3>
<section id="s-put-file-bid-bytes">
<h4><code class="docutils literal notranslate"><span class="pre">s.put-file(bid,</span> <span class="pre">bytes)</span></code><a class="headerlink" href="#s-put-file-bid-bytes" title="Link to this heading">#</a></h4>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">s</span><span class="w"> </span><span class="p">[{</span><span class="n">refs</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]}},</span><span class="w"> </span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">put</span><span class="o">-</span><span class="n">file</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">refs</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="kt">File</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">unique</span><span class="o">-</span><span class="n">file</span><span class="o">-</span><span class="n">id</span><span class="nb">()</span><span class="p">;</span>
<span class="w">  </span><span class="p">{</span><span class="kt">File</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="p">[{</span><span class="n">refs</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="p">[{</span><span class="kt">File</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">},</span><span class="w"> </span><span class="o">...</span><span class="p">],</span><span class="w"> </span><span class="o">...</span><span class="p">]};</span>
</pre></div>
</div>
<p>That is, we allocate a new unique identifier for the file and store whatever
raw bytes we’re provided in that space. We then return this file id.</p>
<p>As always, the bucket must be alive.</p>
</section>
<section id="s-read-file-bid-fid">
<h4><code class="docutils literal notranslate"><span class="pre">s.read-file(bid,</span> <span class="pre">fid)</span></code><a class="headerlink" href="#s-read-file-bid-fid" title="Link to this heading">#</a></h4>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">s</span><span class="w"> </span><span class="p">[{</span><span class="n">refs</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="p">[{</span><span class="n">fid</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">},</span><span class="w"> </span><span class="o">...</span><span class="p">]}},</span><span class="w"> </span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="o">-</span><span class="n">file</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">fid</span><span class="p">)</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">refs</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">bytes</span>
</pre></div>
</div>
<p>That is, we can retrieve the bytes associated with a given file id inside of
the bucket as long as the bucket is alive, and the file exists in the bucket.</p>
</section>
<section id="s-delete-file-bid-fid">
<h4><code class="docutils literal notranslate"><span class="pre">s.delete-file(bid,</span> <span class="pre">fid)</span></code><a class="headerlink" href="#s-delete-file-bid-fid" title="Link to this heading">#</a></h4>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">s</span><span class="w"> </span><span class="p">[{</span><span class="n">refs</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="p">[{</span><span class="n">fid</span><span class="p">,</span><span class="w"> </span><span class="kr">_</span><span class="p">},</span><span class="w"> </span><span class="o">...</span><span class="p">]}},</span><span class="w"> </span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="o">-</span><span class="n">file</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">fid</span><span class="p">)</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">refs</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">s</span><span class="w"> </span><span class="p">[{</span><span class="n">refs</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]}},</span><span class="w"> </span><span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
<p>That is, we can delete a file in the bucket as long as the bucket is alive and
the file exists in the bucket.</p>
</section>
<section id="s-has-file-bid-fid">
<h4><code class="docutils literal notranslate"><span class="pre">s.has-file(bid,</span> <span class="pre">fid)</span></code><a class="headerlink" href="#s-has-file-bid-fid" title="Link to this heading">#</a></h4>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">s</span><span class="w"> </span><span class="p">[{</span><span class="n">refs</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="p">[{</span><span class="n">fid</span><span class="p">,</span><span class="w"> </span><span class="kr">_</span><span class="p">},</span><span class="w"> </span><span class="o">...</span><span class="p">]}},</span><span class="w"> </span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">has</span><span class="o">-</span><span class="n">file</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">fid</span><span class="p">)</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">refs</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">true</span><span class="p">;</span>
<span class="nf">s</span><span class="w"> </span><span class="p">[{</span><span class="n">refs</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]}},</span><span class="w"> </span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">has</span><span class="o">-</span><span class="n">file</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">fid</span><span class="p">)</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">refs</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">false</span><span class="p">;</span>
</pre></div>
</div>
<p>That is, a file exists when we can find it in the bucket. Note that this
operation <strong>requires</strong> the bucket to exist and be alive none the less.</p>
</section>
</section>
</section>
<section id="how-is-this-feature-dangerous">
<h2>How is this feature dangerous?<a class="headerlink" href="#how-is-this-feature-dangerous" title="Link to this heading">#</a></h2>
<p>Kate uses the file storage for critical components, and thus its correct
working depends on it. Here we consider risks from users’, cartridges’, and
Kate’s perspectives.</p>
<dl>
<dt><strong>Files being removed while they’re needed</strong>:</dt><dd><p>Because GC is an automatic storage reclamation process, there’s a risk that
a bug in the GC would lead to corrupted console data in various levels,
including complete failure to boot.</p>
<p>Kate mitigates this in two ways: one, it only uses the file storage for
non-kernel components (so boot is always possible); two, it uses a
uses persistent references to keep long-lived buckets from being reclaimed,
and relies on the browser’s GC to keep track of reference aliasing.</p>
<p>That said, bugs in the file storage’s reference counter and GC are still
problematic. A stable version of Kate should at least look into stochastic
validation of the algorithm as well (e.g.: by checking against a reference
implementation), given that persistent keys are managed manually.</p>
</dd>
<dt><strong>Corrupted files</strong>:</dt><dd><p>Because files are written in a non-transactional fashion to the underlying
storage, there’s a risk that a failure of the storage or device could lead
to corrupted data.</p>
<p>Kate does not mitigate this in the file storage directly, however more
sensitive parts (e.g.: cartridge data) hold both signatures and integrity
hashes for the stored data. Furthermore, we rely on the browser implementation
of the file storage to smooth out other underlying file system issues, though
the specifics are not covered by the specification.</p>
</dd>
<dt><strong>Storage filling attacks</strong>:</dt><dd><p>Because the file storage is intended to be used from cartridges, there’s a
risk that a malicious or misbehaving cartridge might fill the user’s device
storage in an unfair manner.</p>
<p>File storage is subject to similar quotas as the object storage, and thus
users are in control of how much space they wish to allow a cartridge to
use.</p>
</dd>
<dt><strong>Unintended access to files</strong>:</dt><dd><p>Because the file storage is shared between all processes in Kate, there’s
a risk that a malicious cartridge may get access to someone else’s buckets.</p>
<p>While the file storage itself does not implement any access control, it’s
only exposed directly to the Kate kernel, and front-ends to it that are
exposed to cartridges are expected to maintain the proper quota and access
controls themselves. Persistent keys provide the primitive means to do so.</p>
</dd>
</dl>
</section>
<section id="references-and-additional-material">
<h2>References and additional material<a class="headerlink" href="#references-and-additional-material" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://web.dev/articles/origin-private-file-system">Origin-Private File System</a></p></li>
<li><p><a class="reference external" href="https://fs.spec.whatwg.org/">File System living standard</a></p></li>
</ul>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="K0006-cartridge-signatures.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">#K0006 — Cartridge signatures</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="K0004-processes.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">#K0004 — Processes</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023-2024, Niini
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">#K0005 — Partitioned File Storage</a><ul>
<li><a class="reference internal" href="#timeline">Timeline</a></li>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#surface-interface">Surface interface</a></li>
<li><a class="reference internal" href="#ephemeral-and-persistent-buckets">Ephemeral and persistent buckets</a><ul>
<li><a class="reference internal" href="#persistent-references">Persistent references</a></li>
<li><a class="reference internal" href="#ephemeral-buckets-from-cartridges">Ephemeral buckets from cartridges</a></li>
</ul>
</li>
<li><a class="reference internal" href="#formal-semantics">Formal semantics</a><ul>
<li><a class="reference internal" href="#bucket-life-cycle">Bucket life-cycle</a><ul>
<li><a class="reference internal" href="#s-create-bucket"><code class="docutils literal notranslate"><span class="pre">s.create-bucket()</span></code></a></li>
<li><a class="reference internal" href="#s-gc"><code class="docutils literal notranslate"><span class="pre">s.gc()</span></code></a></li>
<li><a class="reference internal" href="#b-drop"><code class="docutils literal notranslate"><span class="pre">b.drop()</span></code></a></li>
<li><a class="reference internal" href="#b-copy"><code class="docutils literal notranslate"><span class="pre">b.copy()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#file-management">File management</a><ul>
<li><a class="reference internal" href="#s-put-file-bid-bytes"><code class="docutils literal notranslate"><span class="pre">s.put-file(bid,</span> <span class="pre">bytes)</span></code></a></li>
<li><a class="reference internal" href="#s-read-file-bid-fid"><code class="docutils literal notranslate"><span class="pre">s.read-file(bid,</span> <span class="pre">fid)</span></code></a></li>
<li><a class="reference internal" href="#s-delete-file-bid-fid"><code class="docutils literal notranslate"><span class="pre">s.delete-file(bid,</span> <span class="pre">fid)</span></code></a></li>
<li><a class="reference internal" href="#s-has-file-bid-fid"><code class="docutils literal notranslate"><span class="pre">s.has-file(bid,</span> <span class="pre">fid)</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-is-this-feature-dangerous">How is this feature dangerous?</a></li>
<li><a class="reference internal" href="#references-and-additional-material">References and additional material</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=594d7d3c"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=32e29ea5"></script>
    </body>
</html>